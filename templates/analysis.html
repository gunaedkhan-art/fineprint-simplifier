{% extends "base.html" %}

{% block title %}Analysis Results - Small Print Checker{% endblock %}

{% block content %}
            <div class="page-header">
                <h1 class="page-title">Analysis Results</h1>
    <p class="page-subtitle">Your document has been analyzed. Review the findings below.</p>
            </div>

            <!-- Analysis Results -->
            <div id="results" class="results-section">
                <!-- Results will be populated by JavaScript -->
            </div>

            <!-- Action Buttons -->
            <div class="analysis-actions">
    <a href="/upload" class="btn-secondary" onclick="this.href='/upload?user_id=' + new URLSearchParams(window.location.search).get('user_id')">Analyze Another Document</a>
                <a href="/compare" class="btn-primary">Compare Documents</a>
            </div>
{% endblock %}

{% block scripts %}
    <script>
        let currentUserId = null;
        let userUsage = null;
        let patternDescriptions = {};

        // Initialize user management
        async function initializeUser() {
    // Get user ID from URL parameters or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user_id');
            
            if (urlUserId) {
                currentUserId = urlUserId;
                localStorage.setItem('fineprint_user_id', currentUserId);
            } else {
                currentUserId = localStorage.getItem('fineprint_user_id');
                if (!currentUserId) {
            // Redirect to login if no user ID
                    window.location.href = '/login';
                    return;
                }
            }
            
            await loadUserUsage();
        }

        async function loadUserUsage() {
            try {
                const response = await fetch(`/api/usage/${currentUserId}`);
                userUsage = await response.json();
            } catch (error) {
                console.error('Error loading usage:', error);
        // Redirect to login if user not found
                window.location.href = '/login';
            }
        }

        // Load stored analysis results
        async function loadAnalysisResults() {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            
            if (!userId) {
        // No user ID, redirect to upload
                window.location.href = '/upload';
                return;
            }
            
            const storedResults = localStorage.getItem(`temp_analysis_${userId}`);
            if (!storedResults) {
        // No stored results, redirect to upload
                window.location.href = '/upload';
                return;
            }
            
            try {
                const results = JSON.parse(storedResults);
                const resultsDiv = document.getElementById("results");
                
                if (!resultsDiv) {
                    console.error('Results div not found');
                    return;
                }
                
        // Clear any existing content
                resultsDiv.innerHTML = '';
                
        // Display full analysis results
                if (results.analysis) {
            // Show success message
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.style.cssText = 'background: #d4edda; color: #155724; padding: 12px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #c3e6cb;';
            successMessage.innerHTML = '‚úÖ Analysis Complete! Here are your detailed results.';
            resultsDiv.appendChild(successMessage);
            
            // Display analysis results
                    displayAnalysisResults(results.analysis);
            processAnalysisData(results);
                } else {
            // Show error message only
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 12px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #f5c6cb;';
                    errorDiv.innerHTML = '‚ùå Analysis Failed<br>Unable to analyze the document. Please try again.';
                    resultsDiv.appendChild(errorDiv);
                }
                
        // Clear the stored results
                localStorage.removeItem(`temp_analysis_${userId}`);
            } catch (error) {
                console.error('Error parsing stored results:', error);
        // Redirect to upload on error
                window.location.href = '/upload';
            }
        }

// Display analysis results
function displayAnalysisResults(analysis) {
    const resultsDiv = document.getElementById("results");
    if (!resultsDiv) return;

    let html = '<div class="analysis-results">';
    
    // Document Quality Assessment
    if (analysis.quality_assessment) {
            const qualityColors = {
                'excellent': '#28a745',
                'good': '#28a745', 
                'fair': '#ffc107',
                'poor': '#dc3545'
            };
        const qualityColor = qualityColors[analysis.quality_assessment] || '#6c757d';
        
        html += `
            <div class="quality-assessment">
                <h3 class="quality-title">üìä Document Quality: ${analysis.quality_assessment.charAt(0).toUpperCase() + analysis.quality_assessment.slice(1)}</h3>
                <p class="quality-details">${analysis.total_pages || 0} pages ‚Ä¢ ${analysis.total_characters || 0} characters ‚Ä¢ ${analysis.readable_pages || 0} readable pages</p>
                </div>
            `;
    }

    // Main findings container with two columns
    const goodPoints = analysis.good_points || {};
    const risks = analysis.risks || {};
    
    if (Object.keys(risks).length > 0 || Object.keys(goodPoints).length > 0) {
        html += `
            <div class="findings-container">
                <div class="findings-column risks-column">
                    <div class="findings-header risks-header">
                        <h2>‚ö†Ô∏è Potential Risks</h2>
                        <p>Issues that may require attention</p>
                    </div>
                    <div class="findings-content">
        `;
        
        // Risks Section
        if (Object.keys(risks).length > 0) {
            for (const [category, matches] of Object.entries(risks)) {
                if (matches && matches.length > 0) {
                    html += `
                        <div class="finding-category-card risk-category">
                            <h3 class="category-title">${formatCategoryName(category)}</h3>
                            <div class="finding-items">
                    `;
                    
                    matches.forEach((item, index) => {
                        const matchText = typeof item === 'string' ? item : item.match || item.phrase || 'Unknown';
                        const pageNum = item.page || 'N/A';
                        const score = item.score || 3;
                        const scoreClass = getRiskScoreClass(score);
                        const findingId = `risk-${category}-${index}`;
                        const description = getDescription(category);
                        
                        html += `
                            <div class="finding-item risk-item">
                                <div class="finding-text">${matchText}</div>
                                <div class="finding-page">Page ${pageNum}</div>
                                <div class="finding-score ${scoreClass}">Risk Score: ${score}/5</div>
                                
                                <div class="finding-description-toggle" onclick="toggleDescription('${findingId}')">
                                    <span class="toggle-icon">‚ñº</span> Why this matters
                                </div>
                                <div class="finding-description" id="desc-${findingId}" style="display: none;">
                                    <div class="desc-section">
                                        <strong>What it means:</strong>
                                        <p>${description.short}</p>
                                    </div>
                                    ${description.why_matters ? `
                                    <div class="desc-section">
                                        <strong>Why it matters:</strong>
                                        <p>${description.why_matters}</p>
                                    </div>
                                    ` : ''}
                                    ${description.watch_for ? `
                                    <div class="desc-section">
                                        <strong>What to watch for:</strong>
                                        <p>${description.watch_for}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                    </div>
                    `;
                }
            }
        } else {
            html += `
                <div class="no-findings-message">
                    <p>‚úÖ No potential risks detected in this document.</p>
                </div>
            `;
        }
        
        html += `
                    </div>
                </div>
                
                <div class="findings-column benefits-column">
                    <div class="findings-header benefits-header">
                        <h2>‚úÖ Benefits Found</h2>
                        <p>Favorable terms and protections</p>
                    </div>
                    <div class="findings-content">
        `;
        
        // Benefits Section
        if (Object.keys(goodPoints).length > 0) {
            for (const [category, matches] of Object.entries(goodPoints)) {
                if (matches && matches.length > 0) {
                html += `
                        <div class="finding-category-card benefit-category">
                            <h3 class="category-title">${formatCategoryName(category)}</h3>
                            <div class="finding-items">
                `;
                
                matches.forEach((item, index) => {
                    const matchText = typeof item === 'string' ? item : item.match || item.phrase || 'Unknown';
                    const pageNum = item.page || 'N/A';
                    const score = item.score || 3;
                    const scoreClass = getBenefitScoreClass(score);
                    const findingId = `benefit-${category}-${index}`;
                    const description = getDescription(category);
                    
                    html += `
                        <div class="finding-item benefit-item">
                            <div class="finding-text">${matchText}</div>
                            <div class="finding-page">Page ${pageNum}</div>
                            <div class="finding-score ${scoreClass}">Benefit Score: ${score}/5</div>
                            
                            <div class="finding-description-toggle" onclick="toggleDescription('${findingId}')">
                                <span class="toggle-icon">‚ñº</span> Why this matters
                            </div>
                            <div class="finding-description" id="desc-${findingId}" style="display: none;">
                                <div class="desc-section">
                                    <strong>What it means:</strong>
                                    <p>${description.short}</p>
                                </div>
                                ${description.why_matters ? `
                                <div class="desc-section">
                                    <strong>Why it matters:</strong>
                                    <p>${description.why_matters}</p>
                                </div>
                                ` : ''}
                                ${description.watch_for ? `
                                <div class="desc-section">
                                    <strong>What to watch for:</strong>
                                    <p>${description.watch_for}</p>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            }
        } else {
            html += `
                <div class="no-findings-message">
                    <p>No specific benefits detected in this document.</p>
                </div>
            `;
        }
        
        html += `
                    </div>
                </div>
            </div>
        `;
    } else {
        // No Findings Message
        html += `
            <div class="no-findings">
                <h3>üîç No Specific Findings</h3>
                <p>No risks or favorable terms were detected in this document. This could mean:</p>
                <ul>
                    <li>The document uses standard, balanced language</li>
                    <li>The terms are written in a way not covered by current patterns</li>
                    <li>The document may need manual review</li>
                </ul>
            </div>
        `;
    }

    html += '</div>';
    resultsDiv.innerHTML = html;
}

// Helper function to get risk score class
function getRiskScoreClass(score) {
    if (score >= 4) return 'score-critical';
    if (score >= 3) return 'score-high';
    if (score >= 2) return 'score-medium';
    return 'score-low';
}

// Helper function to get benefit score class
function getBenefitScoreClass(score) {
    if (score >= 4) return 'score-excellent';
    if (score >= 3) return 'score-good';
    if (score >= 2) return 'score-fair';
    return 'score-minimal';
}

function processAnalysisData(data) {
    // Additional processing if needed
    console.log('Analysis data processed:', data);
}

function formatCategoryName(category) {
    return category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

        // Load pattern descriptions
        async function loadPatternDescriptions() {
            try {
                const response = await fetch('/api/pattern-descriptions');
                if (response.ok) {
                    patternDescriptions = await response.json();
                    console.log('Pattern descriptions loaded:', Object.keys(patternDescriptions).length);
                }
            } catch (error) {
                console.warn('Could not load pattern descriptions:', error);
            }
        }

        // Get description for a pattern category
        function getDescription(category) {
            const desc = patternDescriptions[category];
            if (!desc) {
                return {
                    short: "No description available",
                    why_matters: "",
                    watch_for: ""
                };
            }
            // Handle both old format (string) and new format (object)
            if (typeof desc === 'string') {
                return { short: desc, why_matters: "", watch_for: "" };
            }
            return desc;
        }

        // Toggle description visibility
        function toggleDescription(findingId) {
            const desc = document.getElementById('desc-' + findingId);
            const toggle = desc.previousElementSibling.querySelector('.toggle-icon');
            
            if (desc.style.display === 'none') {
                desc.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                desc.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await loadPatternDescriptions();
            await initializeUser();
            await loadAnalysisResults();
        });
    </script>
{% endblock %}