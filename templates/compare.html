<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Documents - Small Print Checker</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <a href="/" class="logo-link">
                    <h1 class="logo">📋 Small Print Checker</h1>
                </a>
                <nav class="nav">
                    <a href="/" class="nav-link">Home</a>
                    <a href="/upload" class="nav-link">Analyze</a>
                    <a href="/compare" class="nav-link active">Compare</a>
                    <a href="/how-it-works" class="nav-link">How It Works</a>
                    <a href="/pricing" class="nav-link">Pricing</a>
                </nav>
            </div>
        </header>

        <!-- User Status Banner -->
        <div id="user-status-banner" class="user-status-banner" style="display: none;">
            <div class="user-info">
                <span id="user-status-text"></span>
                <span id="usage-info" style="margin-left: 20px;"></span>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="compare-container">
                <div class="compare-section">
                    <h2>Compare Two Documents</h2>
                    <p>Upload two contracts to see which one is better for you. Get a side-by-side comparison of risks, benefits, and key differences.</p>
                    
                    <!-- Pro Feature Notice -->
                    <div id="pro-notice" class="pro-notice" style="display: none;">
                        <div class="pro-banner">
                            <h3>🔒 Pro Feature</h3>
                            <p>Document comparison is available for Pro users only. Upgrade to compare contracts side-by-side.</p>
                            <a href="/pricing" class="btn-primary">Upgrade to Pro</a>
                        </div>
                    </div>

                    <!-- Comparison Form -->
                    <form id="compare-form" class="compare-form" style="display: none;">
                        <input type="hidden" id="user-id-input" name="user_id" value="">
                        
                        <div class="file-upload-grid">
                            <!-- Document 1 -->
                            <div class="file-upload-area">
                                <h3>Document 1</h3>
                                <div class="file-upload-box" id="file1-upload-box">
                                    <div class="upload-icon">📄</div>
                                    <p>Choose first PDF file</p>
                                    <input type="file" id="file1" name="file1" accept=".pdf" required>
                                </div>
                                <div id="file1-info" class="file-info" style="display: none;">
                                    <span id="file1-name"></span>
                                    <button type="button" id="remove-file1" class="btn-remove">✕</button>
                                </div>
                            </div>

                            <!-- Document 2 -->
                            <div class="file-upload-area">
                                <h3>Document 2</h3>
                                <div class="file-upload-box" id="file2-upload-box">
                                    <div class="upload-icon">📄</div>
                                    <p>Choose second PDF file</p>
                                    <input type="file" id="file2" name="file2" accept=".pdf" required>
                                </div>
                                <div id="file2-info" class="file-info" style="display: none;">
                                    <span id="file2-name"></span>
                                    <button type="button" id="remove-file2" class="btn-remove">✕</button>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary btn-large" id="compare-btn">
                            <span id="compare-text">Compare Documents</span>
                            <span id="comparing-text" style="display: none;">Comparing...</span>
                        </button>
                    </form>
                </div>

                <!-- Results Section -->
                <div id="comparison-results" class="comparison-results" style="display: none;"></div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p>&copy; 2025 FinePrint Simplifier. Making contracts understandable for everyone.</p>
            </div>
        </footer>
    </div>

    <script>
        let currentUserId = null;
        let userUsage = null;

        // Initialize user management
        function initializeUser() {
            // Get user ID from URL parameters or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user_id');
            
            if (urlUserId) {
                currentUserId = urlUserId;
                localStorage.setItem('fineprint_user_id', currentUserId);
            } else {
                currentUserId = localStorage.getItem('fineprint_user_id');
                if (!currentUserId) {
                    // Generate a new user ID for visitors
                    currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('fineprint_user_id', currentUserId);
                }
            }
            
            // Set user ID in hidden input
            document.getElementById("user-id-input").value = currentUserId;
            
            // Load user usage
            loadUserUsage();
        }

        async function loadUserUsage() {
            try {
                const response = await fetch(`/api/usage/${currentUserId}`);
                userUsage = await response.json();
                displayUserStatus();
                checkProAccess();
            } catch (error) {
                console.error('Error loading usage:', error);
                showProNotice();
            }
        }

        function displayUserStatus() {
            if (!userUsage) return;

            const statusBanner = document.getElementById("user-status-banner");
            const statusText = document.getElementById("user-status-text");
            const usageInfo = document.getElementById("usage-info");

            statusBanner.style.display = "block";

            if (userUsage.subscription === 'paid') {
                statusText.textContent = "Pro User";
                statusText.className = "status-pro";
                usageInfo.textContent = "Unlimited analyses";
            } else {
                statusText.textContent = "Free User";
                statusText.className = "status-free";
                usageInfo.textContent = `${userUsage.documents_this_month}/${userUsage.monthly_limit} analyses used this month`;
            }
        }

        function checkProAccess() {
            if (userUsage && userUsage.subscription === 'paid') {
                document.getElementById("pro-notice").style.display = "none";
                document.getElementById("compare-form").style.display = "block";
            } else {
                showProNotice();
            }
        }

        function showProNotice() {
            document.getElementById("pro-notice").style.display = "block";
            document.getElementById("compare-form").style.display = "none";
        }

        // File upload handling for Document 1
        document.getElementById("file1").addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById("file1-name").textContent = file.name;
                document.getElementById("file1-info").style.display = "flex";
                document.getElementById("file1-upload-box").style.display = "none";
            }
        });

        document.getElementById("remove-file1").addEventListener("click", function() {
            document.getElementById("file1").value = "";
            document.getElementById("file1-info").style.display = "none";
            document.getElementById("file1-upload-box").style.display = "block";
        });

        // File upload handling for Document 2
        document.getElementById("file2").addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById("file2-name").textContent = file.name;
                document.getElementById("file2-info").style.display = "flex";
                document.getElementById("file2-upload-box").style.display = "none";
            }
        });

        document.getElementById("remove-file2").addEventListener("click", function() {
            document.getElementById("file2").value = "";
            document.getElementById("file2-info").style.display = "none";
            document.getElementById("file2-upload-box").style.display = "block";
        });

        // Drag and drop functionality for Document 1
        const uploadBox1 = document.getElementById("file1-upload-box");
        
        uploadBox1.addEventListener("dragover", function(e) {
            e.preventDefault();
            uploadBox1.classList.add("dragover");
        });

        uploadBox1.addEventListener("dragleave", function(e) {
            e.preventDefault();
            uploadBox1.classList.remove("dragover");
        });

        uploadBox1.addEventListener("drop", function(e) {
            e.preventDefault();
            uploadBox1.classList.remove("dragover");
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === "application/pdf") {
                    document.getElementById("file1").files = files;
                    document.getElementById("file1-name").textContent = file.name;
                    document.getElementById("file1-info").style.display = "flex";
                    document.getElementById("file1-upload-box").style.display = "none";
                } else {
                    alert("Please upload a PDF file.");
                }
            }
        });

        // Drag and drop functionality for Document 2
        const uploadBox2 = document.getElementById("file2-upload-box");
        
        uploadBox2.addEventListener("dragover", function(e) {
            e.preventDefault();
            uploadBox2.classList.add("dragover");
        });

        uploadBox2.addEventListener("dragleave", function(e) {
            e.preventDefault();
            uploadBox2.classList.remove("dragover");
        });

        uploadBox2.addEventListener("drop", function(e) {
            e.preventDefault();
            uploadBox2.classList.remove("dragover");
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === "application/pdf") {
                    document.getElementById("file2").files = files;
                    document.getElementById("file2-name").textContent = file.name;
                    document.getElementById("file2-info").style.display = "flex";
                    document.getElementById("file2-upload-box").style.display = "none";
                } else {
                    alert("Please upload a PDF file.");
                }
            }
        });

        // Form submission
        document.getElementById("compare-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const file1 = document.getElementById("file1").files[0];
            const file2 = document.getElementById("file2").files[0];
            
            if (!file1 || !file2) {
                alert("Please select both documents to compare.");
                return;
            }
            
            // Show comparing state
            document.getElementById("compare-text").style.display = "none";
            document.getElementById("comparing-text").style.display = "inline";
            document.getElementById("compare-btn").disabled = true;
            
            const formData = new FormData();
            formData.append("file1", file1);
            formData.append("file2", file2);
            formData.append("user_id", currentUserId);
            
            try {
                const response = await fetch("/compare", { method: "POST", body: formData });
                const data = await response.json();
                
                if (response.ok) {
                    displayComparisonResults(data);
                } else {
                    alert("Error comparing documents: " + (data.error || "Unknown error"));
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error comparing documents. Please try again.");
            } finally {
                // Reset button state
                document.getElementById("compare-text").style.display = "inline";
                document.getElementById("comparing-text").style.display = "none";
                document.getElementById("compare-btn").disabled = false;
            }
        });

        function displayComparisonResults(data) {
            const resultsDiv = document.getElementById("comparison-results");
            resultsDiv.style.display = "block";
            
            let html = `
                <div class="comparison-container">
                    <h4>📊 Comparison Results</h4>
                    <div class="comparison-grid">
                        <div class="comparison-column">
                            <h5>Document 1</h5>
                            <div class="document-summary">
                                <div class="risk-score ${getRiskScoreClass(data.doc1.risk_score)}">
                                    Risk Score: ${data.doc1.risk_score}/10
                                </div>
                                <div class="findings-summary">
                                    <strong>Risks:</strong> ${data.doc1.risks_count} | 
                                    <strong>Good Points:</strong> ${data.doc1.good_points_count}
                                </div>
                            </div>
                            <div class="document-findings">
                                ${renderFindings(data.doc1.risks, data.doc1.good_points)}
                            </div>
                        </div>
                        
                        <div class="comparison-column">
                            <h5>Document 2</h5>
                            <div class="document-summary">
                                <div class="risk-score ${getRiskScoreClass(data.doc2.risk_score)}">
                                    Risk Score: ${data.doc2.risk_score}/10
                                </div>
                                <div class="findings-summary">
                                    <strong>Risks:</strong> ${data.doc2.risks_count} | 
                                    <strong>Good Points:</strong> ${data.doc2.good_points_count}
                                </div>
                            </div>
                            <div class="document-findings">
                                ${renderFindings(data.doc2.risks, data.doc2.good_points)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="comparison-analysis">
                        <h5>🔍 Key Differences</h5>
                        <div class="differences-list">
                            ${renderDifferences(data.differences)}
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        function getRiskScoreClass(score) {
            if (score >= 7) return "low-risk";
            if (score >= 4) return "medium-risk";
            return "high-risk";
        }

        function renderFindings(risks, goodPoints) {
            let html = "";
            
            if (risks && Object.keys(risks).length > 0) {
                html += "<div class='findings-section'><h6>⚠️ Risks:</h6><ul>";
                Object.entries(risks).forEach(([category, items]) => {
                    items.forEach(item => {
                        const text = typeof item === 'string' ? item : item.match || item.phrase || 'Unknown';
                        html += `<li>${text}</li>`;
                    });
                });
                html += "</ul></div>";
            }
            
            if (goodPoints && Object.keys(goodPoints).length > 0) {
                html += "<div class='findings-section'><h6>✅ Good Points:</h6><ul>";
                Object.entries(goodPoints).forEach(([category, items]) => {
                    items.forEach(item => {
                        const text = typeof item === 'string' ? item : item.match || item.phrase || 'Unknown';
                        html += `<li>${text}</li>`;
                    });
                });
                html += "</ul></div>";
            }
            
            return html;
        }

        function renderDifferences(differences) {
            if (!differences || differences.length === 0) {
                return "<p>No significant differences found between the documents.</p>";
            }
            
            let html = "<ul>";
            differences.forEach(diff => {
                html += `<li><strong>${diff.type}:</strong> ${diff.description}</li>`;
            });
            html += "</ul>";
            
            return html;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeUser();
        });
    </script>
</body>
</html>
