<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze Document - Small Print Checker</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container">
        {% include 'components/header.html' %}


        <!-- Main Content -->
        <main class="main-content">
            <div class="upload-container">
                <div class="upload-section">
                    <div class="page-header">
                        <h1 class="page-title">Analyze Your Document</h1>
                        <p class="page-subtitle">Upload any contract or legal document, or paste text directly to get an instant analysis of risks, benefits, and important terms.</p>
                    </div>
                    
                    <!-- Input Method Toggle -->
                    <div class="input-toggle">
                        <button type="button" class="toggle-btn active" id="file-toggle" onclick="switchToFile()">
                            üìÑ Upload PDF
                        </button>
                        <button type="button" class="toggle-btn" id="text-toggle" onclick="switchToText()">
                            üìù Paste Text
                        </button>
                    </div>
                    
                    <!-- File Upload Form -->
                    <form id="upload-form" class="upload-form">
                        <input type="hidden" id="user-id-input" name="user_id" value="">
                        
                        <div class="file-upload-area" id="file-upload-area">
                            <div class="file-upload-box" id="file-upload-box">
                                <div class="upload-icon">üìÑ</div>
                                <h3>Choose a document</h3>
                                <p>Drag and drop your document here, or click to browse</p>
                                <p class="supported-formats">Supported: PDF, Word (.docx), Images (.jpg, .png, .tiff)</p>
                                <input type="file" id="file" name="file" accept=".pdf,.docx,.jpg,.jpeg,.png,.tiff,.bmp,.gif">
                            </div>
                            <div id="file-info" class="file-info" style="display: none;">
                                <span id="file-name"></span>
                                <button type="button" id="remove-file" class="btn-remove" title="Remove file">‚úï</button>
                            </div>
                            
                            <!-- Progress Indicator -->
                            <div id="processing-status" class="processing-status" style="display: none;">
                                <div class="processing-indicator">
                                    <div class="spinner"></div>
                                    <h3>Processing your document...</h3>
                                    <p class="status-text">This may take a few moments</p>
                                    <div class="progress-steps">
                                        <div class="step" id="step-upload">‚úì Uploading</div>
                                        <div class="step" id="step-extract">‚è≥ Extracting text</div>
                                        <div class="step" id="step-analyze">‚è≥ Analyzing content</div>
                                        <div class="step" id="step-complete">‚è≥ Generating results</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary btn-large" id="analyze-btn">
                            <span id="analyze-text">Analyze Document</span>
                            <span id="analyzing-text" style="display: none;">Analyzing...</span>
                        </button>
                    </form>

                    <!-- Text Input Form -->
                    <form id="text-form" class="text-form" style="display: none;">
                        <input type="hidden" id="text-user-id-input" name="user_id" value="">
                        
                        <div class="text-input-area">
                            <label for="text-content" class="text-label">Paste your text here:</label>
                            <textarea 
                                id="text-content" 
                                name="text_content" 
                                placeholder="Paste any contract text, legal document content, or fine print here for analysis..."
                                rows="12"
                                required
                            ></textarea>
                            <div class="text-counter">
                                <span id="char-count">0</span> characters
                            </div>
                        </div>

                        <button type="submit" class="btn-primary btn-large" id="analyze-text-btn">
                            <span id="analyze-text-text">Analyze Text</span>
                            <span id="analyzing-text-text" style="display: none;">Analyzing...</span>
                        </button>
                    </form>

                    <!-- Usage Display -->
                    <div id="usage-display" class="usage-display" style="display: none;">
                        <div class="usage-info">
                            <span>Documents this month: <span id="documents-this-month">0</span>/<span id="monthly-limit">3</span></span>
                            <span>Total documents: <span id="total-documents">0</span></span>
                        </div>
                    </div>

                    <!-- Upgrade Prompt -->
                    <div id="upgrade-prompt" class="upgrade-prompt" style="display: none;">
                        <h3>Upgrade to Pro for Unlimited Analyses</h3>
                        <p>You've reached your monthly limit. Upgrade to Pro for unlimited document analyses and advanced features.</p>
                        <a href="/pricing" class="btn-primary">Upgrade Now</a>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results" class="results-section" style="display: none;"></div>

                <!-- Email Collection Modal for Free Users -->
                <div id="emailModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <h3>Get Your Analysis Results</h3>
                        <p>Please provide your email to view your analysis results. We'll send you a copy and may contact you about our services.</p>
                        
                        <form id="email-form">
                            <div class="form-group">
                                <label for="userEmail">Email Address:</label>
                                <input type="email" id="userEmail" name="email" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="emailConsent" name="consent">
                                    I agree to receive emails about Small Print Checker services
                                </label>
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" onclick="closeEmailModal()" class="btn-secondary">Cancel</button>
                                <button type="submit" class="btn-primary">View Results</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Legal Disclaimer -->
                <div id="legal-disclaimer-results" class="legal-disclaimer" style="display: none;">
                    <p><strong>Legal Disclaimer:</strong> This analysis is for informational purposes only and should not be considered legal advice. Always consult with a qualified attorney for legal matters.</p>
                </div>
            </div>
        </main>

        {% include 'components/footer.html' %}
    </div>

    <script src="/static/script.js"></script>
    <script>
        let currentUserId = null;
        let userUsage = null;

        // Initialize user management
        async function initializeUser() {
            // Get user ID from localStorage first (updated during registration), then URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user_id');
            const storedUserId = localStorage.getItem('fineprint_user_id');
            
            // Prioritize stored user ID (from registration) over URL parameter (visitor ID)
            if (storedUserId) {
                currentUserId = storedUserId;
                console.log('üîç Using stored user_id:', currentUserId);
            } else if (urlUserId) {
                currentUserId = urlUserId;
                localStorage.setItem('fineprint_user_id', currentUserId);
                console.log('üîç Using URL user_id:', currentUserId);
            } else {
                // Generate a new user ID for visitors
                currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('fineprint_user_id', currentUserId);
                console.log('üîç Generated new user_id:', currentUserId);
            }
            
            // Set user ID in hidden inputs
            document.getElementById("user-id-input").value = currentUserId;
            document.getElementById("text-user-id-input").value = currentUserId;
            
            // Simplified - no complex userUsage loading
            // Usage will be checked server-side during upload
        }

        // Removed loadUserUsage - usage will be checked server-side during upload

        // Removed displayUsage - usage will be shown in upload responses

        // Removed displayUserStatus - user status will be handled by upload responses

        // Input method toggle functions
        function switchToFile() {
            document.getElementById("file-toggle").classList.add("active");
            document.getElementById("text-toggle").classList.remove("active");
            document.getElementById("file-upload-area").style.display = "block";
            document.getElementById("upload-form").style.display = "block";
            document.getElementById("text-form").style.display = "none";
        }

        function switchToText() {
            document.getElementById("text-toggle").classList.add("active");
            document.getElementById("file-toggle").classList.remove("active");
            document.getElementById("text-form").style.display = "block";
            document.getElementById("file-upload-area").style.display = "none";
            document.getElementById("upload-form").style.display = "none";
        }

        // File upload handling
        document.getElementById("file").addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById("file-name").textContent = file.name;
                document.getElementById("file-info").style.display = "flex";
                document.getElementById("file-upload-box").style.display = "none";
            }
        });

        document.getElementById("remove-file").addEventListener("click", function() {
            document.getElementById("file").value = "";
            document.getElementById("file-info").style.display = "none";
            document.getElementById("file-upload-box").style.display = "block";
        });

        // File upload box click handler
        const uploadBox = document.getElementById("file-upload-box");
        const fileInput = document.getElementById("file");
        
        // Click handler to trigger file input
        uploadBox.addEventListener("click", function(e) {
            // Don't trigger if clicking on the file input itself
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });
        
        // Drag and drop functionality
        uploadBox.addEventListener("dragover", function(e) {
            e.preventDefault();
            uploadBox.classList.add("dragover");
        });

        uploadBox.addEventListener("dragleave", function(e) {
            e.preventDefault();
            uploadBox.classList.remove("dragover");
        });

        uploadBox.addEventListener("drop", function(e) {
            e.preventDefault();
            uploadBox.classList.remove("dragover");
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === "application/pdf") {
                    fileInput.files = files;
                    document.getElementById("file-name").textContent = file.name;
                    document.getElementById("file-info").style.display = "flex";
                    document.getElementById("file-upload-box").style.display = "none";
                } else {
                    alert("Please upload a PDF file.");
                }
            }
        });

        // Form submission
        document.getElementById("upload-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById("file");
            if (!fileInput.files.length) {
                alert("Please select a document");
                return;
            }
            
            // Simplified - no frontend usage checking
            // Usage will be checked server-side during upload
            
            // Show progress indicator
            showProcessingStatus();
            
            // Show analyzing state
            document.getElementById("analyze-text").style.display = "none";
            document.getElementById("analyzing-text").style.display = "inline";
            document.getElementById("analyze-btn").disabled = true;
            
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("user_id", currentUserId);

            try {
                // Update progress
                updateProgressStep("step-extract", "completed");
                updateProgressStep("step-analyze", "active");
                updateProgressText("Analyzing document content...");
                
                const res = await fetch("/analyze", { method: "POST", body: formData });
                
                // Check if response is ok before trying to parse JSON
                if (!res.ok) {
                    console.error("Server error:", res.status, res.statusText);
                    const errorText = await res.text();
                    console.error("Error response:", errorText);
                    throw new Error(`Server error: ${res.status} ${res.statusText}`);
                }
                
                const data = await res.json();

                if (res.ok) {
                    // Update progress
                    updateProgressStep("step-analyze", "completed");
                    updateProgressStep("step-complete", "active");
                    updateProgressText("Generating results...");
                    
                    // Small delay to show the final step
                    setTimeout(() => {
                        hideProcessingStatus();
                    }, 500);
                    
                    // Handle different response types based on server response
                    if (data.requires_auth) {
                        // Visitor flow: stash analysis and redirect to registration
                        try {
                            localStorage.setItem('pending_visitor_analysis', JSON.stringify(data));
                        } catch (e) { console.warn('Could not store pending analysis', e); }
                        window.location.href = `/register?user_id=${currentUserId}`;
                    } else {
                        // Authenticated user response - redirect to analysis page
                        localStorage.setItem(`temp_analysis_${currentUserId}`, JSON.stringify(data));
                        window.location.href = `/analysis?user_id=${currentUserId}`;
                    }
                } else {
                    // Handle error responses
                    if (data.error === "Monthly limit reached") {
                        alert(`You've used ${data.usage?.documents_this_month || 0}/${data.usage?.monthly_limit || 3} documents this month. Upgrade to continue analyzing documents.`);
                    } else {
                        alert("Error: " + (data.error || "Unknown error"));
                    }
                }
            } catch (error) {
                console.error("Error:", error);
                hideProcessingStatus();
                alert("Error analyzing document. Please try again.");
            } finally {
                // Reset button state
                document.getElementById("analyze-text").style.display = "inline";
                document.getElementById("analyzing-text").style.display = "none";
                document.getElementById("analyze-btn").disabled = false;
            }
        });

        // Text form submission
        document.getElementById("text-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const textContent = document.getElementById("text-content").value.trim();
            if (!textContent) {
                alert("Please enter some text to analyze");
                return;
            }
            
            // Simplified - no frontend usage checking
            // Usage will be checked server-side during upload
            
            // Show analyzing state
            document.getElementById("analyze-text-text").style.display = "none";
            document.getElementById("analyzing-text-text").style.display = "inline";
            document.getElementById("analyze-text-btn").disabled = true;
            
            try {
                const response = await fetch("/analyze-text", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        text: textContent,
                        user_id: currentUserId
                    })
                });
                
                // This duplicate block has been removed - the logic is handled above
            } catch (error) {
                console.error("Error:", error);
                alert("Error analyzing text. Please try again.");
            } finally {
                // Reset button state
                document.getElementById("analyze-text-text").style.display = "inline";
                document.getElementById("analyzing-text-text").style.display = "none";
                document.getElementById("analyze-text-btn").disabled = false;
            }
        });

        // Text input character counter
        document.addEventListener('DOMContentLoaded', function() {
            const textArea = document.getElementById("text-content");
            const charCount = document.getElementById("char-count");
            
            if (textArea && charCount) {
                textArea.addEventListener('input', function() {
                    charCount.textContent = this.value.length;
                });
            }
        });

        // Email modal functions
        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        async function submitEmailAndShowResults() {
            const email = document.getElementById('userEmail').value.trim();
            const consent = document.getElementById('emailConsent').checked;
            
            if (!email) {
                alert('Please enter a valid email address.');
                return;
            }
            
            if (!isValidEmail(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            try {
                // Update user with email
                const response = await fetch(`/api/update-email/${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        consent: consent
                    })
                });
                
                if (response.ok) {
                    // Close modal and redirect to analysis page
                    closeEmailModal();
                    
                    // Store results and redirect to analysis page
                    localStorage.setItem(`temp_analysis_${currentUserId}`, JSON.stringify(window.tempAnalysisResults));
                    window.location.href = `/analysis?user_id=${currentUserId}`;
                } else {
                    alert('Error saving email. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving email. Please try again.');
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Email form submission
        document.getElementById("email-form").addEventListener("submit", function(e) {
            e.preventDefault();
            submitEmailAndShowResults();
        });

        // Visitor summary function removed - no longer needed with simplified auth flow

        // Analysis results display functions
        function displayAnalysisResults(analysis) {
            const resultsDiv = document.getElementById("results");
            
            if (!analysis || !analysis.success) {
                resultsDiv.innerHTML = `
                    <div class="error-message">
                        <h3>‚ùå Analysis Failed</h3>
                        <p>${analysis?.error || 'Unable to analyze the document. Please try again.'}</p>
                    </div>
                `;
                resultsDiv.style.display = "block";
                return;
            }
            
            // Add quality assessment info if available
            let qualityInfo = "";
            if (analysis.quality_assessment) {
                const qualityColors = {
                    'excellent': '#28a745',
                    'good': '#28a745', 
                    'fair': '#ffc107',
                    'poor': '#dc3545',
                    'unreadable': '#dc3545'
                };
                const qualityColor = qualityColors[analysis.quality_assessment] || '#6c757d';
                qualityInfo = `
                    <div class="quality-assessment" style="background-color: ${qualityColor}; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
                        <strong>Document Quality: ${analysis.quality_assessment.toUpperCase()}</strong>
                        ${analysis.readable_pages && analysis.total_pages ? 
                            `<br>Readable pages: ${analysis.readable_pages}/${analysis.total_pages}` : ''}
                    </div>
                `;
            }

            const risks = analysis.risks || {};
            const goodPoints = analysis.good_points || {};
            const rating = analysis.contract_rating || {};
            const totalMatches = analysis.total_matches || 0;

            let html = `
                <div class="analysis-container">
                    <div class="analysis-header">
                        <h2>üìã Document Analysis Results</h2>
                        <div class="analysis-summary">
                            <div class="summary-item">
                                <span class="summary-label">Total Findings:</span>
                                <span class="summary-value">${totalMatches}</span>
                            </div>
                        </div>
                    </div>
                    ${qualityInfo}
            `;

            // Contract Rating Section
            if (rating.rating && typeof rating.score_out_of_10 === 'number') {
                const scoreClass = rating.score_out_of_10 >= 7 ? 'score-good' : 
                                  rating.score_out_of_10 >= 4 ? 'score-neutral' : 'score-poor';
                
                html += `
                    <div class="rating-section">
                        <h3>üìä Contract Rating</h3>
                        <div class="rating-card ${scoreClass}">
                            <div class="rating-score">${rating.score_out_of_10}/10</div>
                            <div class="rating-description">${rating.rating}</div>
                        </div>
                    </div>
                `;
            }

            // Good Points Section
            if (Object.keys(goodPoints).length > 0) {
                html += `
                    <div class="findings-section good-points">
                        <h3>‚úÖ Favorable Terms Found</h3>
                        <div class="findings-grid">
                `;
                
                for (const [category, matches] of Object.entries(goodPoints)) {
                    if (matches && matches.length > 0) {
                        html += `
                            <div class="finding-category">
                                <h4>${formatCategoryName(category)}</h4>
                                <div class="finding-items">
                        `;
                        
                        matches.forEach(item => {
                            const matchText = typeof item === 'string' ? item : item.match || item.phrase || 'Unknown';
                            const pageNum = item.page || 'N/A';
                            const score = item.score || 3; // Default score if not present
                            const scoreClass = score >= 4 ? 'score-high' : score >= 2.5 ? 'score-medium' : 'score-low';
                            html += `
                                <div class="finding-item good">
                                    <div class="finding-text">${matchText}</div>
                                    <div class="finding-meta">
                                        <span>Page ${pageNum}</span>
                                        <span class="severity-score ${scoreClass}">Severity: ${score}/5</span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += `
                        </div>
                    </div>
                `;
            }

            // Risks Section
            if (Object.keys(risks).length > 0) {
                html += `
                    <div class="findings-section risks">
                        <h3>‚ö†Ô∏è Potential Risks Found</h3>
                        <div class="findings-grid">
                `;
                
                for (const [category, matches] of Object.entries(risks)) {
                    if (matches && matches.length > 0) {
                        html += `
                            <div class="finding-category">
                                <h4>${formatCategoryName(category)}</h4>
                                <div class="finding-items">
                        `;
                        
                        matches.forEach(item => {
                            const matchText = typeof item === 'string' ? item : item.match || item.phrase || 'Unknown';
                            const pageNum = item.page || 'N/A';
                            const score = item.score || 3; // Default score if not present
                            const scoreClass = score >= 4 ? 'score-high' : score >= 2.5 ? 'score-medium' : 'score-low';
                            html += `
                                <div class="finding-item risk">
                                    <div class="finding-text">${matchText}</div>
                                    <div class="finding-meta">
                                        <span>Page ${pageNum}</span>
                                        <span class="severity-score ${scoreClass}">Risk Level: ${score}/5</span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += `
                        </div>
                    </div>
                `;
            }

            // No Findings Message
            if (Object.keys(risks).length === 0 && Object.keys(goodPoints).length === 0) {
                html += `
                    <div class="no-findings">
                        <h3>üîç No Specific Findings</h3>
                        <p>No risks or favorable terms were detected in this document. This could mean:</p>
                        <ul>
                            <li>The document uses standard, balanced language</li>
                            <li>The terms are written in a way not covered by current patterns</li>
                            <li>The document may need manual review</li>
                        </ul>
                    </div>
                `;
            }

            html += `</div>`;
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = "block";
            
            // Show the legal disclaimer when results are displayed
            document.getElementById("legal-disclaimer-results").style.display = "block";
        }

        function processAnalysisData(data) {
            // Pattern data processing moved to admin area
        }

        function formatCategoryName(category) {
            return category
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Visitor signup functions
        // startFree function removed - no longer needed with simplified auth flow

        // Progress indicator functions
        function showProcessingStatus() {
            document.getElementById("processing-status").style.display = "block";
            updateProgressStep("step-upload", "completed");
            updateProgressStep("step-extract", "active");
        }
        
        function hideProcessingStatus() {
            document.getElementById("processing-status").style.display = "none";
            // Reset all steps
            document.querySelectorAll(".step").forEach(step => {
                step.className = "step pending";
            });
        }
        
        function updateProgressStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `step ${status}`;
            }
        }
        
        function updateProgressText(text) {
            const statusText = document.querySelector(".status-text");
            if (statusText) {
                statusText.textContent = text;
            }
        }

        function upgradeToPro() {
            const userId = currentUserId || generateUserId();
            
            // Store the current analysis results with the user ID
            if (window.tempAnalysisResults) {
                localStorage.setItem(`temp_analysis_${userId}`, JSON.stringify(window.tempAnalysisResults));
            }
            
            // Create Stripe checkout session
            fetch(`/api/upgrade/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.checkout_url) {
                    // Redirect to Stripe checkout
                    window.location.href = data.checkout_url;
                } else {
                    alert('Upgrade failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Upgrade error:', error);
                alert('Upgrade failed. Please try again.');
            });
        }

        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeUser();
            // Check for stored results (simplified - no complex timing)
            await checkForStoredResults();
        });

        async function checkForStoredResults() {
            // Simplified - just check for stored results and display them
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            const upgradeCancelled = urlParams.get('upgrade_cancelled');
            
            // Track upgrade abandonment if user cancelled
            if (upgradeCancelled === 'true' && userId) {
                fetch(`/api/track-abandonment/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).catch(error => {
                    console.error('Error tracking abandonment:', error);
                });
            }
            
            if (userId) {
                const storedResults = localStorage.getItem(`temp_analysis_${userId}`);
                if (storedResults) {
                    try {
                        const results = JSON.parse(storedResults);
                        
                        // Show stored results (authentication will be handled by upload endpoint)
                        if (results.analysis) {
                            displayAnalysisResults(results.analysis);
                            processAnalysisData(results);
                        }
                        
                        // Clear the stored results
                        localStorage.removeItem(`temp_analysis_${userId}`);
                    } catch (error) {
                        console.error('Error parsing stored results:', error);
                    }
                }
            }
        }
    </script>
</body>
</html>
