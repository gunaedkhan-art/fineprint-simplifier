<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze Document - Small Print Checker</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container">
        {% include 'components/header.html' %}


        <!-- Main Content -->
        <main class="main-content">
            <div class="upload-container">
                <div class="upload-section">
                    <div class="page-header">
                        <h1 class="page-title">Analyze Your Document</h1>
                        <p class="page-subtitle">Upload any contract or legal document, or paste text directly to get an instant analysis of risks, benefits, and important terms.</p>
                    </div>
                    
                    <!-- Input Method Toggle -->
                    <div class="input-toggle">
                        <button type="button" class="toggle-btn active" id="file-toggle" onclick="switchToFile()">
                            üìÑ Upload PDF
                        </button>
                        <button type="button" class="toggle-btn" id="text-toggle" onclick="switchToText()">
                            üìù Paste Text
                        </button>
                    </div>
                    
                    <!-- File Upload Form -->
                    <form id="upload-form" class="upload-form">
                        <input type="hidden" id="user-id-input" name="user_id" value="">
                        
                        <div class="file-upload-area" id="file-upload-area">
                            <div class="file-upload-box" id="file-upload-box">
                                <div class="upload-icon">üìÑ</div>
                                <h3>Choose a document</h3>
                                <p>Drag and drop your document here, or click to browse</p>
                                <p class="supported-formats">Supported: PDF, Word (.docx), Images (.jpg, .png, .tiff)</p>
                                <input type="file" id="file" name="file" accept=".pdf,.docx,.jpg,.jpeg,.png,.tiff,.bmp,.gif">
                            </div>
                            <div id="file-info" class="file-info" style="display: none;">
                                <span id="file-name"></span>
                                <button type="button" id="remove-file" class="btn-remove" title="Remove file">‚úï</button>
                            </div>
                            
                            <!-- Progress Indicator -->
                            <div id="processing-status" class="processing-status" style="display: none;">
                                <div class="processing-indicator">
                                    <div class="spinner"></div>
                                    <h3>Processing your document...</h3>
                                    <p class="status-text">This may take a few moments</p>
                                    <div class="progress-steps">
                                        <div class="step" id="step-upload">‚úì Uploading</div>
                                        <div class="step" id="step-extract">‚è≥ Extracting text</div>
                                        <div class="step" id="step-analyze">‚è≥ Analyzing content</div>
                                        <div class="step" id="step-complete">‚è≥ Generating results</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary btn-large" id="analyze-btn">
                            <span id="analyze-text">Analyze Document</span>
                            <span id="analyzing-text" style="display: none;">Analyzing...</span>
                        </button>
                    </form>

                    <!-- Usage Limit Upgrade Prompt -->
                    <div id="usageLimitPrompt" class="usage-limit-prompt" style="display: none;">
                        <div class="upgrade-prompt-content">
                            <div class="upgrade-header">
                                <div class="upgrade-icon">üöÄ</div>
                                <h3>You've Reached Your Monthly Limit</h3>
                                <p class="usage-info">
                                    You've used <span id="currentUsage">0</span>/<span id="monthlyLimit">3</span> documents this month
                                </p>
                            </div>
                            
                            <div class="upgrade-benefits">
                                <h4>Upgrade to Pro for:</h4>
                                <ul class="benefits-list">
                                    <li>‚úÖ <strong>Unlimited</strong> document analyses</li>
                                    <li>‚úÖ <strong>Advanced risk scoring</strong> with color-coded badges</li>
                                    <li>‚úÖ <strong>Save up to 50</strong> analysis results</li>
                                    <li>‚úÖ <strong>Export to PDF/Word/Excel</strong></li>
                                    <li>‚úÖ <strong>Side-by-side comparison</strong> of documents</li>
                                    <li>‚úÖ <strong>Priority support</strong></li>
                                </ul>
                            </div>

                            <div class="discount-offer" id="discountOffer" style="display: none;">
                                <div class="discount-badge">
                                    <span class="discount-percentage" id="discountPercentage">10%</span>
                                    <span class="discount-text">OFF</span>
                                </div>
                                <div class="discount-details">
                                    <p class="discount-title">Limited Time Offer!</p>
                                    <p class="discount-subtitle">This discount expires in <span id="discountTimeLeft">5:00</span></p>
                                </div>
                            </div>

                            <div class="upgrade-actions">
                                <a href="#" id="upgradeNowBtn" class="btn-upgrade-primary">
                                    <span class="upgrade-price">
                                        <span class="original-price" id="originalPrice">$9.99</span>
                                        <span class="discounted-price" id="discountedPrice" style="display: none;">$8.99</span>
                                        <span class="price-period">/month</span>
                                    </span>
                                    <span class="upgrade-text">Upgrade to Pro</span>
                                </a>
                                <button onclick="hideUsageLimitPrompt()" class="btn-secondary">Maybe Later</button>
                            </div>

                            <div class="upgrade-footer">
                                <p>‚úÖ Cancel anytime ‚Ä¢ ‚úÖ 30-day money-back guarantee</p>
                            </div>
                        </div>
                    </div>

                    <!-- Text Input Form -->
                    <form id="text-form" class="text-form" style="display: none;">
                        <input type="hidden" id="text-user-id-input" name="user_id" value="">
                        
                        <div class="text-input-area">
                            <label for="text-content" class="text-label">Paste your text here:</label>
                            <textarea 
                                id="text-content" 
                                name="text_content" 
                                placeholder="Paste any contract text, legal document content, or fine print here for analysis..."
                                rows="12"
                                required
                            ></textarea>
                            <div class="text-counter">
                                <span id="char-count">0</span> characters
                            </div>
                        </div>

                        <button type="submit" class="btn-primary btn-large" id="analyze-text-btn">
                            <span id="analyze-text-text">Analyze Text</span>
                            <span id="analyzing-text-text" style="display: none;">Analyzing...</span>
                        </button>
                    </form>

                    <!-- Usage Display -->
                    <div id="usage-display" class="usage-display" style="display: none;">
                        <div class="usage-info">
                            <span>Documents this month: <span id="documents-this-month">0</span>/<span id="monthly-limit">3</span></span>
                            <span>Total documents: <span id="total-documents">0</span></span>
                        </div>
                    </div>

                    <!-- Upgrade Prompt -->
                    <div id="upgrade-prompt" class="upgrade-prompt" style="display: none;">
                        <h3>Upgrade to Pro for Unlimited Analyses</h3>
                        <p>You've reached your monthly limit. Upgrade to Pro for unlimited document analyses and advanced features.</p>
                        <a href="/pricing" class="btn-primary">Upgrade Now</a>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results" class="results-section" style="display: none;"></div>

                <!-- Email Collection Modal for Free Users -->
                <div id="emailModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <h3>Get Your Analysis Results</h3>
                        <p>Please provide your email to view your analysis results. We'll send you a copy and may contact you about our services.</p>
                        
                        <form id="email-form">
                            <div class="form-group">
                                <label for="userEmail">Email Address:</label>
                                <input type="email" id="userEmail" name="email" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="emailConsent" name="consent">
                                    I agree to receive emails about Small Print Checker services
                                </label>
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" onclick="closeEmailModal()" class="btn-secondary">Cancel</button>
                                <button type="submit" class="btn-primary">View Results</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Legal Disclaimer -->
                <div id="legal-disclaimer-results" class="legal-disclaimer" style="display: none;">
                    <p><strong>Legal Disclaimer:</strong> This analysis is for informational purposes only and should not be considered legal advice. Always consult with a qualified attorney for legal matters.</p>
                </div>
            </div>
        </main>

        {% include 'components/footer.html' %}
    </div>

    <script src="/static/script.js"></script>
    <script>
        let currentUserId = null;
        let userUsage = null;

        // Initialize user management
        async function initializeUser() {
            // Get user ID from localStorage first (updated during registration), then URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user_id');
            const storedUserId = localStorage.getItem('fineprint_user_id');
            
            // Prioritize stored user ID (from registration) over URL parameter (visitor ID)
            if (storedUserId) {
                currentUserId = storedUserId;
                console.log('üîç Using stored user_id:', currentUserId);
            } else if (urlUserId) {
                currentUserId = urlUserId;
                localStorage.setItem('fineprint_user_id', currentUserId);
                console.log('üîç Using URL user_id:', currentUserId);
            } else {
                // Generate a new user ID for visitors
                currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('fineprint_user_id', currentUserId);
                console.log('üîç Generated new user_id:', currentUserId);
            }
            
            // Set user ID in hidden inputs
            document.getElementById("user-id-input").value = currentUserId;
            document.getElementById("text-user-id-input").value = currentUserId;
            
            // Simplified - no complex userUsage loading
            // Usage will be checked server-side during upload
        }

        // Removed loadUserUsage - usage will be checked server-side during upload

        // Removed displayUsage - usage will be shown in upload responses

        // Removed displayUserStatus - user status will be handled by upload responses

        // Input method toggle functions
        function switchToFile() {
            document.getElementById("file-toggle").classList.add("active");
            document.getElementById("text-toggle").classList.remove("active");
            document.getElementById("file-upload-area").style.display = "block";
            document.getElementById("upload-form").style.display = "block";
            document.getElementById("text-form").style.display = "none";
        }

        function switchToText() {
            document.getElementById("text-toggle").classList.add("active");
            document.getElementById("file-toggle").classList.remove("active");
            document.getElementById("text-form").style.display = "block";
            document.getElementById("file-upload-area").style.display = "none";
            document.getElementById("upload-form").style.display = "none";
        }

        // File upload handling
        document.getElementById("file").addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById("file-name").textContent = file.name;
                document.getElementById("file-info").style.display = "flex";
                document.getElementById("file-upload-box").style.display = "none";
            }
        });

        document.getElementById("remove-file").addEventListener("click", function() {
            document.getElementById("file").value = "";
            document.getElementById("file-info").style.display = "none";
            document.getElementById("file-upload-box").style.display = "block";
        });

        // File upload box click handler
        const uploadBox = document.getElementById("file-upload-box");
        const fileInput = document.getElementById("file");
        
        // Click handler to trigger file input
        uploadBox.addEventListener("click", function(e) {
            // Don't trigger if clicking on the file input itself
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });
        
        // Drag and drop functionality
        uploadBox.addEventListener("dragover", function(e) {
            e.preventDefault();
            uploadBox.classList.add("dragover");
        });

        uploadBox.addEventListener("dragleave", function(e) {
            e.preventDefault();
            uploadBox.classList.remove("dragover");
        });

        uploadBox.addEventListener("drop", function(e) {
            e.preventDefault();
            uploadBox.classList.remove("dragover");
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === "application/pdf") {
                    fileInput.files = files;
                    document.getElementById("file-name").textContent = file.name;
                    document.getElementById("file-info").style.display = "flex";
                    document.getElementById("file-upload-box").style.display = "none";
                } else {
                    alert("Please upload a PDF file.");
                }
            }
        });

        // Form submission
        document.getElementById("upload-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById("file");
            if (!fileInput.files.length) {
                alert("Please select a document");
                return;
            }
            
            // Simplified - no frontend usage checking
            // Usage will be checked server-side during upload
            
            // Show progress indicator
            showProcessingStatus();
            
            // Show analyzing state
            document.getElementById("analyze-text").style.display = "none";
            document.getElementById("analyzing-text").style.display = "inline";
            document.getElementById("analyze-btn").disabled = true;
            
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("user_id", currentUserId);

            try {
                // Update progress
                updateProgressStep("step-extract", "completed");
                updateProgressStep("step-analyze", "active");
                updateProgressText("Analyzing document content...");
                
                const res = await fetch("/analyze", { method: "POST", body: formData });
                
                // Check if response is ok before trying to parse JSON
                if (!res.ok) {
                    console.error("Server error:", res.status, res.statusText);
                    let errorMessage = `Server error: ${res.status}`;
                    
                    try {
                        const errorData = await res.json();
                        console.error("Error response:", errorData);
                        
                        // Show user-friendly error message if available
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        } else if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (parseError) {
                        console.error("Could not parse error response as JSON");
                        const errorText = await res.text();
                        console.error("Error response:", errorText);
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const data = await res.json();

                if (res.ok) {
                    // Update progress
                    updateProgressStep("step-analyze", "completed");
                    updateProgressStep("step-complete", "active");
                    updateProgressText("Generating results...");
                    
                    // Small delay to show the final step
                    setTimeout(() => {
                        hideProcessingStatus();
                    }, 500);
                    
                    // Handle different response types based on server response
                    if (data.requires_auth) {
                        // Visitor flow: show success message and account creation prompt in context
                        showVisitorSuccessPrompt(data);
                        try {
                            localStorage.setItem('pending_visitor_analysis', JSON.stringify(data));
                        } catch (e) { console.warn('Could not store pending analysis', e); }
                    } else {
                        // Authenticated user response - redirect to analysis page
                        localStorage.setItem(`temp_analysis_${currentUserId}`, JSON.stringify(data));
                        window.location.href = `/analysis?user_id=${currentUserId}`;
                    }
                } else {
                    // Handle error responses
                    if (data.error === "Monthly limit reached") {
                        showUsageLimitPrompt(data);
                    } else if (data.requires_account) {
                        // Show account creation prompt instead of generic error
                        showAccountRequiredPrompt();
                    } else {
                        alert("Error: " + (data.error || "Unknown error"));
                    }
                }
            } catch (error) {
                console.error("Error:", error);
                hideProcessingStatus();
                alert("Error analyzing document. Please try again.");
            } finally {
                // Reset button state
                document.getElementById("analyze-text").style.display = "inline";
                document.getElementById("analyzing-text").style.display = "none";
                document.getElementById("analyze-btn").disabled = false;
            }
        });

        // Text form submission
        document.getElementById("text-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const textContent = document.getElementById("text-content").value.trim();
            if (!textContent) {
                alert("Please enter some text to analyze");
                return;
            }
            
            // Simplified - no frontend usage checking
            // Usage will be checked server-side during upload
            
            // Show analyzing state
            document.getElementById("analyze-text-text").style.display = "none";
            document.getElementById("analyzing-text-text").style.display = "inline";
            document.getElementById("analyze-text-btn").disabled = true;
            
            try {
                const response = await fetch("/analyze-text", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        text: textContent,
                        user_id: currentUserId
                    })
                });
                
                // Check if response is ok before trying to parse JSON
                if (!response.ok) {
                    console.error("Server error:", response.status, response.statusText);
                    let errorMessage = `Server error: ${response.status}`;
                    
                    try {
                        const errorData = await response.json();
                        console.error("Error response:", errorData);
                        
                        // Show user-friendly error message if available
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        } else if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (parseError) {
                        console.error("Could not parse error response as JSON");
                        const errorText = await response.text();
                        console.error("Error response:", errorText);
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                // Handle successful response
                if (data.requires_auth) {
                    // Visitor flow: show success message and account creation prompt in context
                    showVisitorSuccessPrompt(data);
                    try {
                        localStorage.setItem('pending_visitor_analysis', JSON.stringify(data));
                    } catch (e) { console.warn('Could not store pending analysis', e); }
                } else {
                    // Authenticated user response - redirect to analysis page
                    localStorage.setItem(`temp_analysis_${currentUserId}`, JSON.stringify(data));
                    window.location.href = `/analysis?user_id=${currentUserId}`;
                }
                
            } catch (error) {
                console.error("Error:", error);
                if (error.message && error.message.includes("Account required")) {
                    showAccountRequiredPrompt();
                } else {
                    alert(error.message || "Error analyzing text. Please try again.");
                }
            } finally {
                // Reset button state
                document.getElementById("analyze-text-text").style.display = "inline";
                document.getElementById("analyzing-text-text").style.display = "none";
                document.getElementById("analyze-text-btn").disabled = false;
            }
        });

        // Text input character counter
        document.addEventListener('DOMContentLoaded', function() {
            const textArea = document.getElementById("text-content");
            const charCount = document.getElementById("char-count");
            
            if (textArea && charCount) {
                textArea.addEventListener('input', function() {
                    charCount.textContent = this.value.length;
                });
            }
        });

        // Email modal functions
        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        function showAccountRequiredPrompt() {
            // Show a clear call-to-action to create an account
            const resultsDiv = document.getElementById("results");
            if (!resultsDiv) return;
            
            resultsDiv.innerHTML = `
                <div class="account-required-prompt">
                    <div class="prompt-header">
                        <h2>üîí Account Required</h2>
                        <p>Create an account or sign in to analyze this document</p>
                    </div>
                    
                    <div class="prompt-cta">
                        <p>You've used your free uploads for today. Create an account to continue analyzing documents with unlimited access.</p>
                        <div class="cta-buttons">
                            <button onclick="window.location.href='/register'" class="btn-primary">Create Free Account</button>
                            <button onclick="window.location.href='/login'" class="btn-secondary">Sign In</button>
                        </div>
                        <p class="cta-note">Free accounts get 3 document analyses per month</p>
                    </div>
                </div>
            `;
            resultsDiv.style.display = "block";
        }

        function showVisitorSuccessPrompt(data) {
            // Show success message and account creation prompt in context
            const resultsDiv = document.getElementById("results");
            if (!resultsDiv) return;
            
            resultsDiv.innerHTML = `
                <div class="visitor-success-prompt">
                    <div class="success-header">
                        <h2>‚úÖ Document Analyzed Successfully!</h2>
                        <p>Your document has been processed and analyzed</p>
                    </div>
                    
                    <div class="success-cta">
                        <p>Create a free account to view your detailed analysis results, including:</p>
                        <ul>
                            <li>üìä Risk assessment and scoring</li>
                            <li>‚ö†Ô∏è Potential issues and concerns</li>
                            <li>‚úÖ Positive clauses and benefits</li>
                            <li>üìù Plain English summary</li>
                        </ul>
                        
                        <div class="cta-buttons">
                            <button onclick="window.location.href='/register?user_id=${currentUserId}'" class="btn-primary">Create Free Account</button>
                            <button onclick="window.location.href='/login'" class="btn-secondary">Sign In</button>
                        </div>
                        
                        <p class="cta-note">Free accounts get 3 document analyses per month</p>
                    </div>
                </div>
            `;
            resultsDiv.style.display = "block";
        }

        async function submitEmailAndShowResults() {
            const email = document.getElementById('userEmail').value.trim();
            const consent = document.getElementById('emailConsent').checked;
            
            if (!email) {
                alert('Please enter a valid email address.');
                return;
            }
            
            if (!isValidEmail(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            try {
                // Update user with email
                const response = await fetch(`/api/update-email/${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        consent: consent
                    })
                });
                
                if (response.ok) {
                    // Close modal and redirect to analysis page
                    closeEmailModal();
                    
                    // Store results and redirect to analysis page
                    localStorage.setItem(`temp_analysis_${currentUserId}`, JSON.stringify(window.tempAnalysisResults));
                    window.location.href = `/analysis?user_id=${currentUserId}`;
                } else {
                    alert('Error saving email. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving email. Please try again.');
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Email form submission
        document.getElementById("email-form").addEventListener("submit", function(e) {
            e.preventDefault();
            submitEmailAndShowResults();
        });

        // Visitor summary function removed - no longer needed with simplified auth flow

        // Analysis results display functions
        function displayAnalysisResults(analysis) {
            const resultsDiv = document.getElementById("results");
            
            if (!analysis || !analysis.success) {
                resultsDiv.innerHTML = `
                    <div class="error-message">
                        <h3>‚ùå Analysis Failed</h3>
                        <p>${analysis?.error || 'Unable to analyze the document. Please try again.'}</p>
                    </div>
                `;
                resultsDiv.style.display = "block";
                return;
            }
            
            // Add quality assessment info if available
            let qualityInfo = "";
            if (analysis.quality_assessment) {
                const qualityColors = {
                    'excellent': '#28a745',
                    'good': '#28a745', 
                    'fair': '#ffc107',
                    'poor': '#dc3545',
                    'unreadable': '#dc3545'
                };
                const qualityColor = qualityColors[analysis.quality_assessment] || '#6c757d';
                qualityInfo = `
                    <div class="quality-assessment" style="background-color: ${qualityColor}; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
                        <strong>Document Quality: ${analysis.quality_assessment.toUpperCase()}</strong>
                        ${analysis.readable_pages && analysis.total_pages ? 
                            `<br>Readable pages: ${analysis.readable_pages}/${analysis.total_pages}` : ''}
                    </div>
                `;
            }

            const risks = analysis.risks || {};
            const goodPoints = analysis.good_points || {};
            const rating = analysis.contract_rating || {};
            const totalMatches = analysis.total_matches || 0;

            let html = `
                <div class="analysis-container">
                    <div class="analysis-header">
                        <h2>üìã Document Analysis Results</h2>
                        <div class="analysis-summary">
                            <div class="summary-item">
                                <span class="summary-label">Total Findings:</span>
                                <span class="summary-value">${totalMatches}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Analysis Banner -->
                    <div id="saveAnalysisBanner" class="save-analysis-banner" style="display: none;">
                        <div class="save-banner-content">
                            <h3>üíæ Save This Analysis</h3>
                            <div class="save-form">
                                <div class="form-group">
                                    <label for="analysisName">Analysis Name:</label>
                                    <input type="text" id="analysisName" placeholder="Enter a name for this analysis..." />
                                </div>
                                <div class="form-group">
                                    <label for="analysisNotes">Notes (optional):</label>
                                    <textarea id="analysisNotes" placeholder="Add any notes about this analysis..." rows="2"></textarea>
                                </div>
                                <div class="save-actions">
                                    <button onclick="saveAnalysis()" class="btn-save" id="saveBtn">Save Analysis</button>
                                    <div class="save-count" id="saveCountDisplay">0 / 50 saved</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upgrade Prompt for Free Users -->
                    <div id="upgradePrompt" class="upgrade-prompt" style="display: none;">
                        <div class="upgrade-content">
                            <h3>üíé Save Your Analysis</h3>
                            <p>Pro users can save up to 50 analysis results with custom names and notes for future reference.</p>
                            <div class="upgrade-actions">
                                <a href="/pricing" class="btn-upgrade">Upgrade to Pro</a>
                                <button onclick="hideUpgradePrompt()" class="btn-secondary">Maybe Later</button>
                            </div>
                        </div>
                    </div>
                    
                    ${qualityInfo}
            `;

            // Contract Rating Section
            if (rating.rating && typeof rating.score_out_of_10 === 'number') {
                const scoreClass = rating.score_out_of_10 >= 7 ? 'score-good' : 
                                  rating.score_out_of_10 >= 4 ? 'score-neutral' : 'score-poor';
                
                html += `
                    <div class="rating-section">
                        <h3>üìä Contract Rating</h3>
                        <div class="rating-card ${scoreClass}">
                            <div class="rating-score">${rating.score_out_of_10}/10</div>
                            <div class="rating-description">${rating.rating}</div>
                        </div>
                    </div>
                `;
            }

            // Good Points Section
            if (Object.keys(goodPoints).length > 0) {
                html += `
                    <div class="findings-section good-points">
                        <h3>‚úÖ Favorable Terms Found</h3>
                        <div class="findings-grid">
                `;
                
                for (const [category, matches] of Object.entries(goodPoints)) {
                    if (matches && matches.length > 0) {
                        html += `
                            <div class="finding-category">
                                <h4>${formatCategoryName(category)}</h4>
                                <div class="finding-items">
                        `;
                        
                        matches.forEach(item => {
                            const matchText = typeof item === 'string' ? item : item.match || item.phrase || 'Unknown';
                            const pageNum = item.page || 'N/A';
                            const score = item.score || 3; // Default score if not present
                            const scoreClass = score >= 4 ? 'score-high' : score >= 2.5 ? 'score-medium' : 'score-low';
                            html += `
                                <div class="finding-item good">
                                    <div class="finding-text">${matchText}</div>
                                    <div class="finding-meta">
                                        <span>Page ${pageNum}</span>
                                        <span class="severity-score ${scoreClass}">Severity: ${score}/5</span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += `
                        </div>
                    </div>
                `;
            }

            // Risks Section
            if (Object.keys(risks).length > 0) {
                html += `
                    <div class="findings-section risks">
                        <h3>‚ö†Ô∏è Potential Risks Found</h3>
                        <div class="findings-grid">
                `;
                
                for (const [category, matches] of Object.entries(risks)) {
                    if (matches && matches.length > 0) {
                        html += `
                            <div class="finding-category">
                                <h4>${formatCategoryName(category)}</h4>
                                <div class="finding-items">
                        `;
                        
                        matches.forEach(item => {
                            const matchText = typeof item === 'string' ? item : item.match || item.phrase || 'Unknown';
                            const pageNum = item.page || 'N/A';
                            const score = item.score || 3; // Default score if not present
                            const scoreClass = score >= 4 ? 'score-high' : score >= 2.5 ? 'score-medium' : 'score-low';
                            html += `
                                <div class="finding-item risk">
                                    <div class="finding-text">${matchText}</div>
                                    <div class="finding-meta">
                                        <span>Page ${pageNum}</span>
                                        <span class="severity-score ${scoreClass}">Risk Level: ${score}/5</span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += `
                        </div>
                    </div>
                `;
            }

            // No Findings Message
            if (Object.keys(risks).length === 0 && Object.keys(goodPoints).length === 0) {
                html += `
                    <div class="no-findings">
                        <h3>üîç No Specific Findings</h3>
                        <p>No risks or favorable terms were detected in this document. This could mean:</p>
                        <ul>
                            <li>The document uses standard, balanced language</li>
                            <li>The terms are written in a way not covered by current patterns</li>
                            <li>The document may need manual review</li>
                        </ul>
                    </div>
                `;
            }

            html += `</div>`;
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = "block";
            
            // Show the legal disclaimer when results are displayed
            document.getElementById("legal-disclaimer-results").style.display = "block";
            
            // Show save prompt for users
            showSavePromptForAnalysis(analysis);
        }

        function processAnalysisData(data) {
            // Pattern data processing moved to admin area
        }

        function formatCategoryName(category) {
            return category
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Visitor signup functions
        // startFree function removed - no longer needed with simplified auth flow

        // Progress indicator functions
        function showProcessingStatus() {
            document.getElementById("processing-status").style.display = "block";
            updateProgressStep("step-upload", "completed");
            updateProgressStep("step-extract", "active");
        }
        
        function hideProcessingStatus() {
            document.getElementById("processing-status").style.display = "none";
            // Reset all steps
            document.querySelectorAll(".step").forEach(step => {
                step.className = "step pending";
            });
        }
        
        function updateProgressStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `step ${status}`;
            }
        }
        
        function updateProgressText(text) {
            const statusText = document.querySelector(".status-text");
            if (statusText) {
                statusText.textContent = text;
            }
        }

        function upgradeToPro() {
            const userId = currentUserId || generateUserId();
            
            // Store the current analysis results with the user ID
            if (window.tempAnalysisResults) {
                localStorage.setItem(`temp_analysis_${userId}`, JSON.stringify(window.tempAnalysisResults));
            }
            
            // Create Stripe checkout session
            fetch(`/api/upgrade/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.checkout_url) {
                    // Redirect to Stripe checkout
                    window.location.href = data.checkout_url;
                } else {
                    alert('Upgrade failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Upgrade error:', error);
                alert('Upgrade failed. Please try again.');
            });
        }

        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeUser();
            // Check for stored results (simplified - no complex timing)
            await checkForStoredResults();
        });

        async function checkForStoredResults() {
            // Simplified - just check for stored results and display them
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            const upgradeCancelled = urlParams.get('upgrade_cancelled');
            
            // Track upgrade abandonment if user cancelled
            if (upgradeCancelled === 'true' && userId) {
                fetch(`/api/track-abandonment/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).catch(error => {
                    console.error('Error tracking abandonment:', error);
                });
            }
            
            if (userId) {
                const storedResults = localStorage.getItem(`temp_analysis_${userId}`);
                if (storedResults) {
                    try {
                        const results = JSON.parse(storedResults);
                        
                        // Show stored results (authentication will be handled by upload endpoint)
                        if (results.analysis) {
                            displayAnalysisResults(results.analysis);
                            processAnalysisData(results);
                        }
                        
                        // Clear the stored results
                        localStorage.removeItem(`temp_analysis_${userId}`);
                    } catch (error) {
                        console.error('Error parsing stored results:', error);
                    }
                }
            }
        }

        // Usage Limit Upgrade Prompt Functions
        let discountTimer = null;

        function showUsageLimitPrompt(data) {
            // Update usage info
            document.getElementById('currentUsage').textContent = data.usage?.documents_this_month || 0;
            document.getElementById('monthlyLimit').textContent = data.usage?.monthly_limit || 3;
            
            // Show discount offer if available
            if (data.discount_offer) {
                showDiscountOffer(data.discount_offer);
            }
            
            // Show the prompt
            document.getElementById('usageLimitPrompt').style.display = 'block';
            
            // Scroll to the prompt
            document.getElementById('usageLimitPrompt').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }

        function hideUsageLimitPrompt() {
            document.getElementById('usageLimitPrompt').style.display = 'none';
            if (discountTimer) {
                clearInterval(discountTimer);
                discountTimer = null;
            }
        }

        function showDiscountOffer(discountData) {
            const discountOffer = document.getElementById('discountOffer');
            const discountPercentage = document.getElementById('discountPercentage');
            const originalPrice = document.getElementById('originalPrice');
            const discountedPrice = document.getElementById('discountedPrice');
            
            // Show discount offer
            discountOffer.style.display = 'flex';
            discountPercentage.textContent = discountData.percentage + '%';
            
            // Calculate discounted price
            const originalPriceValue = 9.99;
            const discountedPriceValue = originalPriceValue * (1 - discountData.percentage / 100);
            
            // Update prices
            originalPrice.style.textDecoration = 'line-through';
            originalPrice.style.opacity = '0.6';
            discountedPrice.textContent = '$' + discountedPriceValue.toFixed(2);
            discountedPrice.style.display = 'inline';
            
            // Start countdown timer
            startDiscountCountdown(discountData.expires_at);
            
            // Update upgrade button with discount code
            const upgradeBtn = document.getElementById('upgradeNowBtn');
            upgradeBtn.href = `/pricing?discount=${discountData.code}`;
        }

        function startDiscountCountdown(expiresAt) {
            const timeLeftElement = document.getElementById('discountTimeLeft');
            
            function updateCountdown() {
                const now = Math.floor(Date.now() / 1000);
                const timeLeft = expiresAt - now;
                
                if (timeLeft <= 0) {
                    // Discount expired
                    hideDiscountOffer();
                    return;
                }
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timeLeftElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Update immediately
            updateCountdown();
            
            // Update every second
            discountTimer = setInterval(updateCountdown, 1000);
        }

        function hideDiscountOffer() {
            const discountOffer = document.getElementById('discountOffer');
            const originalPrice = document.getElementById('originalPrice');
            const discountedPrice = document.getElementById('discountedPrice');
            
            discountOffer.style.display = 'none';
            originalPrice.style.textDecoration = 'none';
            originalPrice.style.opacity = '1';
            discountedPrice.style.display = 'none';
            
            if (discountTimer) {
                clearInterval(discountTimer);
                discountTimer = null;
            }
        }

        function showSavePromptForAnalysis(analysis) {
            // Store the current analysis data for saving
            currentAnalysisData = analysis;
            
            // Get the filename from the current upload
            const fileInput = document.getElementById('file');
            if (fileInput && fileInput.files.length > 0) {
                currentFilename = fileInput.files[0].name;
            }
            
            // Check user subscription and show appropriate prompt
            if (userSubscription === 'premium') {
                showSavePrompt('premium');
            } else {
                showSavePrompt('free');
            }
        }

        function showSavePrompt(userSubscription) {
            if (userSubscription === 'premium') {
                document.getElementById('saveAnalysisBanner').style.display = 'block';
                document.getElementById('upgradePrompt').style.display = 'none';
                loadSaveCount();
            } else {
                document.getElementById('upgradePrompt').style.display = 'block';
                document.getElementById('saveAnalysisBanner').style.display = 'none';
            }
        }

        function hideUpgradePrompt() {
            document.getElementById('upgradePrompt').style.display = 'none';
        }

        function setCurrentAnalysis(analysisData, filename) {
            currentAnalysisData = analysisData;
            currentFilename = filename;
            
            // Pre-fill the analysis name with filename
            if (filename) {
                const nameInput = document.getElementById('analysisName');
                if (nameInput) {
                    nameInput.value = filename.replace(/\.[^/.]+$/, ""); // Remove extension
                }
            }
        }

        async function loadSaveCount() {
            try {
                const response = await fetch(`/api/saved-analyses?user_id=${currentUserId}`);
                const data = await response.json();
                
                if (data.success) {
                    const countDisplay = document.getElementById('saveCountDisplay');
                    if (countDisplay) {
                        countDisplay.textContent = `${data.total_count} / 50 saved`;
                    }
                }
            } catch (error) {
                console.error('Error loading save count:', error);
            }
        }

        async function saveAnalysis() {
            const nameInput = document.getElementById('analysisName');
            const notesInput = document.getElementById('analysisNotes');
            const saveBtn = document.getElementById('saveBtn');
            
            if (!nameInput || !currentAnalysisData) {
                alert('No analysis data to save');
                return;
            }
            
            const analysisName = nameInput.value.trim();
            if (!analysisName) {
                alert('Please enter a name for this analysis');
                return;
            }
            
            const notes = notesInput ? notesInput.value.trim() : '';
            
            // Disable save button to prevent double-clicks
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            try {
                const formData = new FormData();
                formData.append('analysis_name', analysisName);
                formData.append('original_filename', currentFilename || 'Unknown file');
                formData.append('notes', notes);
                formData.append('analysis_data', JSON.stringify(currentAnalysisData));
                formData.append('user_id', currentUserId);
                
                const response = await fetch('/api/save-analysis', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    showSaveSuccess(data.message, data.save_count);
                    
                    // Update save count
                    const countDisplay = document.getElementById('saveCountDisplay');
                    if (countDisplay) {
                        countDisplay.textContent = `${data.save_count} / 50 saved`;
                    }
                    
                    // Clear form
                    nameInput.value = '';
                    if (notesInput) notesInput.value = '';
                } else {
                    if (data.upgrade_required) {
                        // Show upgrade prompt instead
                        document.getElementById('saveAnalysisBanner').style.display = 'none';
                        document.getElementById('upgradePrompt').style.display = 'block';
                    } else {
                        alert('Error saving analysis: ' + (data.error || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Error saving analysis:', error);
                alert('Network error saving analysis. Please try again.');
            } finally {
                // Re-enable save button
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Analysis';
            }
        }

        function showSaveSuccess(message, saveCount) {
            // Create a temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'save-success-message';
            successDiv.innerHTML = `
                <div class="success-content">
                    <span class="success-icon">‚úÖ</span>
                    <span class="success-text">${message}</span>
                </div>
            `;
            
            // Insert after the save banner
            const saveBanner = document.getElementById('saveAnalysisBanner');
            saveBanner.parentNode.insertBefore(successDiv, saveBanner.nextSibling);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }
    </script>

    <style>
        /* Save Analysis Banner Styles */
        .save-analysis-banner, .upgrade-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .save-banner-content h3, .upgrade-content h3 {
            margin: 0 0 1rem 0;
            font-size: 1.3rem;
        }

        .save-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea {
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .form-group input::placeholder, .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.15);
        }

        .save-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-save {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-save:hover:not(:disabled) {
            background: #229954;
        }

        .btn-save:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .save-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .upgrade-content p {
            margin: 0 0 1rem 0;
            opacity: 0.9;
        }

        .upgrade-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-upgrade {
            background: #f39c12;
            color: white;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-upgrade:hover {
            background: #e67e22;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .save-success-message {
            background: #27ae60;
            color: white;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            animation: slideIn 0.3s ease-out;
        }

        .success-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .success-icon {
            font-size: 1.2rem;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .save-form {
                grid-template-columns: 1fr;
            }
            
            .save-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .upgrade-actions {
                flex-direction: column;
            }
        }

        /* Usage Limit Upgrade Prompt Styles */
        .usage-limit-prompt {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upgrade-prompt-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .upgrade-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .upgrade-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upgrade-header h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .usage-info {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .upgrade-benefits {
            margin-bottom: 2rem;
        }

        .upgrade-benefits h4 {
            margin: 0 0 1rem 0;
            font-size: 1.3rem;
            text-align: center;
        }

        .benefits-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.75rem;
        }

        .benefits-list li {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 1rem;
            border-left: 3px solid #27ae60;
        }

        .discount-offer {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            border: 2px solid #f39c12;
        }

        .discount-badge {
            background: #f39c12;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            min-width: 80px;
            font-weight: bold;
        }

        .discount-percentage {
            display: block;
            font-size: 1.8rem;
            line-height: 1;
        }

        .discount-text {
            font-size: 0.9rem;
        }

        .discount-details {
            flex: 1;
        }

        .discount-title {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .discount-subtitle {
            margin: 0;
            opacity: 0.9;
            font-size: 1rem;
        }

        .upgrade-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .btn-upgrade-primary {
            background: #27ae60;
            color: white;
            text-decoration: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-upgrade-primary:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .upgrade-price {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .original-price {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .discounted-price {
            font-size: 1.4rem;
            font-weight: 700;
            color: #f39c12;
        }

        .price-period {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .upgrade-text {
            font-size: 1rem;
        }

        .upgrade-footer {
            text-align: center;
            opacity: 0.8;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .usage-limit-prompt {
                padding: 1.5rem;
                margin: 1rem 0;
            }

            .benefits-list {
                grid-template-columns: 1fr;
            }

            .discount-offer {
                flex-direction: column;
                text-align: center;
            }

            .upgrade-actions {
                flex-direction: column;
            }

            .btn-upgrade-primary {
                padding: 1.25rem 2rem;
            }
        }
    </style>
</body>
</html>
