<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Small Print Checker</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container">
        {% include 'components/header.html' %}

        <!-- Main Content -->
        <main class="main-content">
            <div class="auth-container">
                <div class="auth-card">
                    <div class="auth-header">
                        <h1>Create New Password</h1>
                        <p>Enter your new password below</p>
                    </div>
                    
                    <form id="resetPasswordForm" class="auth-form">
                        <input type="hidden" id="token" name="token" value="{{ token }}">
                        
                        <div class="form-group">
                            <label for="new_password">New Password</label>
                            <input type="password" id="new_password" name="new_password" required placeholder="Enter new password" minlength="8">
                            <small style="color: var(--text-muted); display: block; margin-top: 4px;">Minimum 8 characters</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm_password">Confirm Password</label>
                            <input type="password" id="confirm_password" name="confirm_password" required placeholder="Confirm new password">
                        </div>
                        
                        <button type="submit" class="btn-primary btn-full" id="resetBtn">
                            Reset Password
                        </button>
                    </form>
                    
                    <div id="resetResult" style="display: none; margin-top: 20px;"></div>
                    
                    <div class="auth-footer">
                        <p><a href="/login">← Back to Login</a></p>
                    </div>
                </div>
            </div>
        </main>
        
        {% include 'components/footer.html' %}
    </div>

    <script>
        // Check if token is present
        const urlParams = new URLSearchParams(window.location.search);
        const tokenFromUrl = urlParams.get('token');
        
        if (tokenFromUrl) {
            document.getElementById('token').value = tokenFromUrl;
        }
        
        if (!document.getElementById('token').value) {
            const resultDiv = document.getElementById('resetResult');
            resultDiv.innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 16px; border-radius: 8px; border: 1px solid #f5c6cb;">
                    <h3 style="margin: 0 0 8px 0;">❌ Invalid Reset Link</h3>
                    <p style="margin: 0 0 12px 0;">This password reset link is invalid or has expired.</p>
                    <a href="/forgot-password" style="color: var(--primary-color); font-weight: 600;">Request a new reset link</a>
                </div>
            `;
            resultDiv.style.display = 'block';
            document.getElementById('resetPasswordForm').style.display = 'none';
        }
        
        document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const token = document.getElementById('token').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            const resetBtn = document.getElementById('resetBtn');
            const resultDiv = document.getElementById('resetResult');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                resultDiv.innerHTML = `
                    <div style="background: #fff3cd; color: #856404; padding: 16px; border-radius: 8px; border: 1px solid #ffeeba;">
                        <h3 style="margin: 0 0 8px 0;">⚠️ Passwords Don't Match</h3>
                        <p style="margin: 0;">Please make sure both passwords are the same.</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }
            
            // Validate password length
            if (newPassword.length < 8) {
                resultDiv.innerHTML = `
                    <div style="background: #fff3cd; color: #856404; padding: 16px; border-radius: 8px; border: 1px solid #ffeeba;">
                        <h3 style="margin: 0 0 8px 0;">⚠️ Password Too Short</h3>
                        <p style="margin: 0;">Password must be at least 8 characters long.</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }
            
            // Show loading state
            const originalText = resetBtn.textContent;
            resetBtn.textContent = 'Resetting...';
            resetBtn.disabled = true;
            resultDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        token: token,
                        new_password: newPassword 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 16px; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <h3 style="margin: 0 0 8px 0;">✅ Password Reset Successful</h3>
                            <p style="margin: 0 0 12px 0;">${data.message}</p>
                            <a href="/login" style="display: inline-block; background: var(--primary-color); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; margin-top: 8px;">
                                Go to Login
                            </a>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    
                    // Hide the form
                    document.getElementById('resetPasswordForm').style.display = 'none';
                    
                    // Redirect to login after 3 seconds
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Reset failed');
                }
            } catch (error) {
                console.error('Password reset error:', error);
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 16px; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h3 style="margin: 0 0 8px 0;">❌ Error</h3>
                        <p style="margin: 0 0 12px 0;">${error.message}</p>
                        ${error.message.includes('expired') ? `
                            <a href="/forgot-password" style="color: var(--primary-color); font-weight: 600;">Request a new reset link</a>
                        ` : ''}
                    </div>
                `;
                resultDiv.style.display = 'block';
                
                // Reset button state
                resetBtn.textContent = originalText;
                resetBtn.disabled = false;
            }
        });
    </script>
    
    <script src="/static/script.js"></script>
</body>
</html>

