<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Small Print Checker</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container">
        {% include 'components/header.html' %}

        <!-- Main Content -->
        <main class="main-content">
            <div class="profile-container">
                <div class="profile-header">
                    <h1>My Profile</h1>
                    <p>Manage your account and subscription</p>
                </div>
                
                <div class="profile-grid">
                    <!-- Account Information -->
                    <div class="profile-card">
                        <h2>Account Information</h2>
                        <div class="info-item">
                            <label>Email:</label>
                            <span>{{ user.email }}</span>
                        </div>
                        <div class="info-item">
                            <label>Member Since:</label>
                            <span>{{ user_data.created_at[:10] if user_data else 'N/A' }}</span>
                        </div>
                        <div class="info-item">
                            <label>User ID:</label>
                            <span class="user-id">{{ user.user_id }}</span>
                        </div>
                    </div>
                    
                    <!-- Subscription Status -->
                    <div class="profile-card">
                        <h2>Subscription Status</h2>
                        {% if user_data and user_data.subscription == 'paid' %}
                            <div class="subscription-status paid">
                                <div class="status-badge">Pro</div>
                                <p>You have an active Pro subscription</p>
                                <div class="subscription-details">
                                    <div class="info-item">
                                        <label>Status:</label>
                                        <span class="status-active">{{ user_data.subscription_status }}</span>
                                    </div>
                                    {% if user_data.subscription_expires %}
                                    <div class="info-item">
                                        <label>Expires:</label>
                                        <span>{{ user_data.subscription_expires[:10] }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                <a href="/subscription-management" class="btn-primary">Manage Subscription</a>
                            </div>
                        {% else %}
                            <div class="subscription-status free">
                                <div class="status-badge">Free</div>
                                <p>You're using the free tier</p>
                                <div class="subscription-details">
                                    <div class="info-item">
                                        <label>Plan:</label>
                                        <span>Free (3 documents/month)</span>
                                    </div>
                                </div>
                                <a href="/pricing" class="btn-primary">Upgrade to Pro</a>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Usage Statistics -->
                    <div class="profile-card">
                        <h2>Usage Statistics</h2>
                        {% if user_data %}
                            <div class="usage-stats">
                                <div class="stat-item">
                                    <div class="stat-number">{{ user_data.usage.documents_this_month }}</div>
                                    <div class="stat-label">Documents This Month</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number">{{ user_data.usage.total_documents }}</div>
                                    <div class="stat-label">Total Documents</div>
                                </div>
                                {% if user_data.subscription == 'free' %}
                                <div class="stat-item">
                                    <div class="stat-number">{{ 3 - user_data.usage.documents_this_month }}</div>
                                    <div class="stat-label">Remaining This Month</div>
                                </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <p>No usage data available</p>
                        {% endif %}
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="profile-card">
                        <h2>Quick Actions</h2>
                        <div class="action-buttons">
                            <a href="/upload" class="btn-primary">Analyze Document</a>
                            <a href="/compare" class="btn-secondary">Compare Documents</a>
                            <a href="/pricing" class="btn-secondary">View Pricing</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/static/script.js"></script>
    <script>
        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            initializeMobileMenu();
        });

        async function checkAuthStatus() {
            const token = localStorage.getItem('access_token');
            if (token) {
                try {
                    const response = await fetch('/api/user-subscription-data', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            updateUserStatusInfo(data.user_data);
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                }
            }
            
            // If not authenticated, redirect to home
            window.location.href = '/';
        }

        function updateUserStatusInfo(userData) {
            const planElement = document.getElementById('userPlan');
            const usageElement = document.getElementById('userUsage');
            const avatar = document.getElementById('profileAvatar');
            
            if (planElement && usageElement) {
                // Update plan status
                if (userData.subscription === 'paid') {
                    planElement.textContent = 'Pro';
                    planElement.className = 'status-value pro';
                } else {
                    planElement.textContent = 'Free';
                    planElement.className = 'status-value free';
                }
                
                // Update usage info
                const documentsThisMonth = userData.documents_this_month || 0;
                const monthlyLimit = userData.subscription === 'paid' ? 'âˆž' : '3';
                usageElement.textContent = `${documentsThisMonth}/${monthlyLimit}`;
            }
            
            // Update avatar with user initial
            if (avatar && userData.email) {
                avatar.textContent = userData.email.charAt(0).toUpperCase();
            }
            
            // Show subscription management if user has paid subscription
            if (userData.subscription === 'paid') {
                document.getElementById('subscriptionLink').style.display = 'block';
                document.getElementById('mobileSubscriptionLink').style.display = 'block';
            }
        }

        function logout() {
            // Remove token from localStorage and cookie
            localStorage.removeItem('access_token');
            document.cookie = 'access_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            
            // Redirect to home page
            window.location.href = '/';
        }

        function initializeMobileMenu() {
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            const mobileNav = document.querySelector('.mobile-nav');
            
            if (mobileMenuToggle && mobileNav) {
                mobileMenuToggle.addEventListener('click', function() {
                    mobileMenuToggle.classList.toggle('active');
                    mobileNav.classList.toggle('active');
                });
            }
        }
    </script>
    
    {% include 'components/footer.html' %}
</body>
</html>
