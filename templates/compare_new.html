{% extends "base.html" %}

{% block title %}Compare Documents - Small Print Checker{% endblock %}

{% block content %}
<div class="compare-container">
    <div class="page-header">
        <h1 class="page-title">Compare Documents</h1>
        <p class="page-subtitle">Upload two contracts to see which one is better for you. Get a side-by-side comparison of risks, benefits, and key differences.</p>
    </div>

    <!-- Use Cases Section -->
    <section class="use-cases-section">
        <h2>Why Compare Documents?</h2>
        <div class="use-cases-grid">
            <div class="use-case-card">
                <div class="use-case-icon">üè¢</div>
                <h3>Job Offers</h3>
                <p>Compare employment contracts to see which offer has better benefits, salary structure, and terms.</p>
                <div class="use-case-example">
                    <strong>Example:</strong> "Company A offers 20% more salary but Company B has better health insurance and flexible hours."
                </div>
            </div>
            
            <div class="use-case-card">
                <div class="use-case-icon">üè†</div>
                <h3>Rental Agreements</h3>
                <p>Compare lease terms to find the best rental deal with favorable conditions and fewer restrictions.</p>
                <div class="use-case-example">
                    <strong>Example:</strong> "Apartment A has lower rent but Apartment B allows pets and has no security deposit."
                </div>
            </div>
            
            <div class="use-case-card">
                <div class="use-case-icon">üí≥</div>
                <h3>Service Contracts</h3>
                <p>Compare service agreements to identify the most favorable terms, pricing, and cancellation policies.</p>
                <div class="use-case-example">
                    <strong>Example:</strong> "Provider A has lower monthly fees but Provider B offers better cancellation terms and support."
                </div>
            </div>
            
            <div class="use-case-card">
                <div class="use-case-icon">ü§ù</div>
                <h3>Partnership Agreements</h3>
                <p>Compare business partnership terms to ensure fair profit sharing and clear responsibilities.</p>
                <div class="use-case-example">
                    <strong>Example:</strong> "Agreement A gives you 60% profit but Agreement B provides better intellectual property protection."
                </div>
            </div>
            
            <div class="use-case-card">
                <div class="use-case-icon">üíº</div>
                <h3>Employment Contracts</h3>
                <p>Compare job offers to identify the best compensation, benefits, and work conditions.</p>
                <div class="use-case-example">
                    <strong>Example:</strong> "Job A offers higher salary but Job B has better benefits package and remote work options."
                </div>
            </div>
            
            <div class="use-case-card">
                <div class="use-case-icon">üìã</div>
                <h3>Terms of Service</h3>
                <p>Compare different service providers' terms to understand your rights and obligations.</p>
                <div class="use-case-example">
                    <strong>Example:</strong> "Platform A has stricter data policies but Platform B offers better dispute resolution."
                </div>
            </div>
        </div>
    </section>

    <!-- Pro Feature Notice -->
    <section class="pro-feature-section">
        <div class="pro-banner">
            <div class="pro-content">
                <h3>Pro Feature: Document Comparison</h3>
                <p>Compare contracts side-by-side to make informed decisions. This advanced feature is available for Pro users only.</p>
                <div class="pro-benefits">
                    <div class="benefit-item">
                        <span class="benefit-icon">üìä</span>
                        <span>Side-by-side risk analysis</span>
                    </div>
                    <div class="benefit-item">
                        <span class="benefit-icon">‚öñÔ∏è</span>
                        <span>Key differences highlighted</span>
                    </div>
                    <div class="benefit-item">
                        <span class="benefit-icon">üéØ</span>
                        <span>Recommendation engine</span>
                    </div>
                </div>
                <div class="pro-actions">
                    <a href="/pricing" class="btn-primary btn-large">Upgrade to Pro</a>
                    <a href="/upload" class="btn-secondary">Analyze Single Document</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Comparison Form (Hidden for non-Pro users) -->
    <section class="compare-form-section" id="compare-form-section" style="display: none;">
        <h2>Upload Your Documents</h2>
        <form id="compare-form" class="compare-form">
            <input type="hidden" id="user-id-input" name="user_id" value="">
            
            <div class="file-upload-grid">
                <!-- Document 1 -->
                <div class="file-upload-area">
                    <h3>Document 1</h3>
                    <div class="file-upload-box" id="file1-upload-box">
                        <div class="upload-icon">üìÑ</div>
                        <p>Choose first document</p>
                        <p class="supported-formats">PDF, Word, Images</p>
                        <input type="file" id="file1" name="file1" accept=".pdf,.docx,.jpg,.jpeg,.png,.tiff,.bmp,.gif" required>
                    </div>
                    <div id="file1-info" class="file-info" style="display: none;">
                        <span id="file1-name"></span>
                        <button type="button" id="remove-file1" class="btn-remove">‚úï</button>
                    </div>
                </div>

                <!-- Document 2 -->
                <div class="file-upload-area">
                    <h3>Document 2</h3>
                    <div class="file-upload-box" id="file2-upload-box">
                        <div class="upload-icon">üìÑ</div>
                        <p>Choose second document</p>
                        <p class="supported-formats">PDF, Word, Images</p>
                        <input type="file" id="file2" name="file2" accept=".pdf,.docx,.jpg,.jpeg,.png,.tiff,.bmp,.gif" required>
                    </div>
                    <div id="file2-info" class="file-info" style="display: none;">
                        <span id="file2-name"></span>
                        <button type="button" id="remove-file2" class="btn-remove">‚úï</button>
                    </div>
                </div>
            </div>

            <div class="compare-actions">
                <button type="submit" class="btn-primary btn-large" id="compare-btn">
                    <span id="compare-text">Compare Documents</span>
                    <span id="comparing-text" style="display: none;">Comparing...</span>
                </button>
            </div>
        </form>
    </section>

    <!-- Results Section -->
    <div id="comparison-results" class="comparison-results" style="display: none;"></div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
let currentUserId = null;
let userUsage = null;

// Initialize user management
function initializeUser() {
    // Get user ID from URL parameters or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const urlUserId = urlParams.get('user_id');
    
    if (urlUserId) {
        currentUserId = urlUserId;
        localStorage.setItem('fineprint_user_id', currentUserId);
    } else {
        currentUserId = localStorage.getItem('fineprint_user_id');
        if (!currentUserId) {
            // Generate a new user ID for visitors
            currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('fineprint_user_id', currentUserId);
        }
    }
    
    // Set user ID in hidden input
    document.getElementById("user-id-input").value = currentUserId;
    
    // Load user usage
    loadUserUsage();
}

async function loadUserUsage() {
    try {
        const response = await fetch(`/api/usage/${currentUserId}`);
        userUsage = await response.json();
        checkProAccess();
    } catch (error) {
        console.error('Error loading usage:', error);
    }
}

function checkProAccess() {
    if (userUsage && userUsage.subscription === 'paid') {
        document.getElementById("compare-form-section").style.display = "block";
    }
}

// File upload handling for Document 1
document.getElementById("file1").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById("file1-name").textContent = file.name;
        document.getElementById("file1-info").style.display = "flex";
        document.getElementById("file1-upload-box").style.display = "none";
    }
});

document.getElementById("remove-file1").addEventListener("click", function() {
    document.getElementById("file1").value = "";
    document.getElementById("file1-info").style.display = "none";
    document.getElementById("file1-upload-box").style.display = "block";
});

// File upload handling for Document 2
document.getElementById("file2").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById("file2-name").textContent = file.name;
        document.getElementById("file2-info").style.display = "flex";
        document.getElementById("file2-upload-box").style.display = "none";
    }
});

document.getElementById("remove-file2").addEventListener("click", function() {
    document.getElementById("file2").value = "";
    document.getElementById("file2-info").style.display = "none";
    document.getElementById("file2-upload-box").style.display = "block";
});

// Drag and drop functionality for Document 1
const uploadBox1 = document.getElementById("file1-upload-box");

uploadBox1.addEventListener("dragover", function(e) {
    e.preventDefault();
    uploadBox1.classList.add("dragover");
});

uploadBox1.addEventListener("dragleave", function(e) {
    e.preventDefault();
    uploadBox1.classList.remove("dragover");
});

uploadBox1.addEventListener("drop", function(e) {
    e.preventDefault();
    uploadBox1.classList.remove("dragover");
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        document.getElementById("file1").files = files;
        document.getElementById("file1-name").textContent = file.name;
        document.getElementById("file1-info").style.display = "flex";
        document.getElementById("file1-upload-box").style.display = "none";
    }
});

// Drag and drop functionality for Document 2
const uploadBox2 = document.getElementById("file2-upload-box");

uploadBox2.addEventListener("dragover", function(e) {
    e.preventDefault();
    uploadBox2.classList.add("dragover");
});

uploadBox2.addEventListener("dragleave", function(e) {
    e.preventDefault();
    uploadBox2.classList.remove("dragover");
});

uploadBox2.addEventListener("drop", function(e) {
    e.preventDefault();
    uploadBox2.classList.remove("dragover");
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        document.getElementById("file2").files = files;
        document.getElementById("file2-name").textContent = file.name;
        document.getElementById("file2-info").style.display = "flex";
        document.getElementById("file2-upload-box").style.display = "none";
    }
});

// Form submission
document.getElementById("compare-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const file1 = document.getElementById("file1").files[0];
    const file2 = document.getElementById("file2").files[0];
    
    if (!file1 || !file2) {
        alert("Please select both documents to compare.");
        return;
    }
    
    // Show comparing state
    document.getElementById("compare-text").style.display = "none";
    document.getElementById("comparing-text").style.display = "inline";
    document.getElementById("compare-btn").disabled = true;
    
    const formData = new FormData();
    formData.append("file1", file1);
    formData.append("file2", file2);
    formData.append("user_id", currentUserId);
    
    try {
        const response = await fetch("/compare", { method: "POST", body: formData });
        const data = await response.json();
        
        if (response.ok) {
            displayComparisonResults(data);
        } else {
            alert("Error comparing documents: " + (data.error || "Unknown error"));
        }
    } catch (error) {
        console.error("Error:", error);
        alert("Error comparing documents. Please try again.");
    } finally {
        // Reset button state
        document.getElementById("compare-text").style.display = "inline";
        document.getElementById("comparing-text").style.display = "none";
        document.getElementById("compare-btn").disabled = false;
    }
});

function displayComparisonResults(data) {
    const resultsDiv = document.getElementById("comparison-results");
    resultsDiv.style.display = "block";
    
    let html = `
        <div class="comparison-container">
            <h4>üìä Comparison Results</h4>
            <div class="comparison-grid">
                <div class="comparison-column">
                    <h5>Document 1</h5>
                    <div class="document-summary">
                        <div class="risk-score ${getRiskScoreClass(data.doc1.risk_score)}">
                            Risk Score: ${data.doc1.risk_score}/10
                        </div>
                        <div class="findings-summary">
                            <strong>Risks:</strong> ${data.doc1.risks_count} | 
                            <strong>Good Points:</strong> ${data.doc1.good_points_count}
                        </div>
                    </div>
                    <div class="document-findings">
                        ${renderFindings(data.doc1.risks, data.doc1.good_points)}
                    </div>
                </div>
                
                <div class="comparison-column">
                    <h5>Document 2</h5>
                    <div class="document-summary">
                        <div class="risk-score ${getRiskScoreClass(data.doc2.risk_score)}">
                            Risk Score: ${data.doc2.risk_score}/10
                        </div>
                        <div class="findings-summary">
                            <strong>Risks:</strong> ${data.doc2.risks_count} | 
                            <strong>Good Points:</strong> ${data.doc2.good_points_count}
                        </div>
                    </div>
                    <div class="document-findings">
                        ${renderFindings(data.doc2.risks, data.doc2.good_points)}
                    </div>
                </div>
            </div>
            
            <div class="comparison-analysis">
                <h5>üîç Key Differences</h5>
                <div class="differences-list">
                    ${renderDifferences(data.differences)}
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
}

function getRiskScoreClass(score) {
    if (score >= 7) return "low-risk";
    if (score >= 4) return "medium-risk";
    return "high-risk";
}

function renderFindings(risks, goodPoints) {
    let html = "";
    
    if (risks && Object.keys(risks).length > 0) {
        html += "<div class='findings-section'><h6>‚ö†Ô∏è Risks:</h6><ul>";
        Object.entries(risks).forEach(([category, items]) => {
            items.forEach(item => {
                const text = typeof item === 'string' ? item : item.match || item.phrase || 'Unknown';
                html += `<li>${text}</li>`;
            });
        });
        html += "</ul></div>";
    }
    
    if (goodPoints && Object.keys(goodPoints).length > 0) {
        html += "<div class='findings-section'><h6>‚úÖ Good Points:</h6><ul>";
        Object.entries(goodPoints).forEach(([category, items]) => {
            items.forEach(item => {
                const text = typeof item === 'string' ? item : item.match || item.phrase || 'Unknown';
                html += `<li>${text}</li>`;
            });
        });
        html += "</ul></div>";
    }
    
    return html;
}

function renderDifferences(differences) {
    if (!differences || differences.length === 0) {
        return "<p>No significant differences found between the documents.</p>";
    }
    
    let html = "<ul>";
    differences.forEach(diff => {
        html += `<li><strong>${diff.type}:</strong> ${diff.description}</li>`;
    });
    html += "</ul>";
    
    return html;
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeUser();
});
</script>
{% endblock %}
